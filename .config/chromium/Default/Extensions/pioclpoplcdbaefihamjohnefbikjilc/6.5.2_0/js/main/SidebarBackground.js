/*! Copyright 2009-2015 Evernote Corporation. All rights reserved. */
define(["GlobalUtils","isTest"],function(a,b){"use strict";function c(a,b){function c(){var c={},d=extension.getPendingNote(a.pendingNoteKey);d||(d={}),d.relatedNotes||(d.relatedNotes={}),d.relatedNotes.pers=i&&i.relatedNotes?i.relatedNotes.list:[],j&&(d.relatedNotes.biz=j.relatedNotes?j.relatedNotes.list:[],d.relatedNotes.containingNotebooks=h),extension.setPendingNote(a.pendingNoteKey,d),a.notesOnly?a.callback(a.pendingNoteKey,b):("smartFiling"===options.get("notebookSelection")&&(i&&i.notebook&&(c.notebook=i.notebook),p&&options.get("bizSmartFilingEnabled")&&j&&j.notebook&&!j.notebook.restrictions.noCreateNotes&&(c.notebook=j.notebook,c.notebook.biz=!0)),options.get("smartFilingTags")&&(i&&i.tags&&(c.tags=i.tags),p&&j&&j.tags&&c.notebook&&c.notebook.biz&&(c.tags=j.tags)),c.name="receiveSmartFilingInfo",Browser.sendToTab(b.tab,c))}function d(){k=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations"],null,options.get("secureProto"),extension.getBootstrapInfo("serviceHost"),options.get("overrideServiceURL")),k.initWithAuthToken(o,function(){p?(l=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations"],null,options.get("secureProto"),extension.getBootstrapInfo("serviceHost"),options.get("overrideServiceURL")),l.initWithAuthToken(p,function(){e()})):e()})}function e(){var c={relatedNotesResultSpec:{includeAttributes:!0,includeNotebookGuid:!0,includeTitle:!0,includeUpdated:!0},text:a.recText,url:a.url||b.tab.url};options.get("includeDebugInfo")&&(c.relatedNotesResultSpec.includeDebugInfo=!0);var d=options.get("relatedNotesContext").trim();""!=d&&(c.context=d),JsonQueue.handleExpensiveOpRequest({shardId:k.shardId,userId:q,type:"pers"},k.client.NoteStoreExtra.getFilingRecommendations,g,o,c),p&&JsonQueue.handleExpensiveOpRequest({shardId:l.shardId,userId:q,type:"biz"},l.client.NoteStoreExtra.getFilingRecommendations,f,p,c)}function f(a,b){if(n=!0,a){if(a.relatedNotes){h={};for(var d=0;d<a.containingNotebooks.list.length;d++){var e=a.containingNotebooks.list[d];h[e.guid]={joined:e.hasSharedNotebook,name:e.notebookDisplayName,contact:e.contactName}}}a.debugInfo&&(r.write("DEBUG_INFO",a.debugInfo),delete a.debugInfo),j=a}else log.error(b);m&&c()}function g(b,d){m=!0,b?(i=b,b.debugInfo&&(r.write("TEXT",a.recText),r.write("DEBUG_INFO",b.debugInfo),delete b.debugInfo)):log.error(d),(p&&n||!p)&&c()}var h,i,j,k,l,m,n,o=auth.getUserInfo().authenticationToken,p=auth.getUserInfo().bizAuthenticationToken,q=auth.getCurrentUser(),r=new LogWriter("relatedNotesDebugInfo");a.recText&&a.recText.trim()?d():c()}function d(b,c){function d(){e(),f(),w.bizAuthenticationToken?g():Browser.sendToTab(c.tab,{name:(b.page?b.page+"_":"")+"receiveBusinessNotebooks",notebooks:[]})}function e(){O.getFilteredSyncChunk(w.authenticationToken,K[x].personal,v,new SyncChunkFilter({includeExpunged:L,includeNotebooks:!0,omitSharedNotebooks:!0}),h,n)}function f(){O.getFilteredSyncChunk(w.authenticationToken,K[x].linked,v,new SyncChunkFilter({includeExpunged:M,includeLinkedNotebooks:!0}),i,n)}function g(){Q.getFilteredSyncChunk(w.bizAuthenticationToken,K[x].business,v,new SyncChunkFilter({includeExpunged:N,includeNotebooks:!0,omitSharedNotebooks:!0}),j,n)}function h(a){for(var d in a.notebooks)r(G[x].personal,G[x].personalIndices,a.notebooks[d]);for(var d in a.expungedNotebooks)s(G[x].personal,G[x].personalIndices,a.expungedNotebooks[d]);Persistent.set("notebooks",G),K[x].personal=a.chunkHighUSN,Persistent.set("updateCounts",K),a.updateCount===K[x].personal?Browser.sendToTab(c.tab,{name:(b.page?b.page+"_":"")+"receivePersonalNotebooks",alwaysStartInNotebookGuid:J,notebooks:G[x].personal,recentNotebookGuid:I}):e()}function i(a){for(var b in a.linkedNotebooks){var c=a.linkedNotebooks[b];c.sharedNotebookGlobalId&&c.shardId&&(r(G[x].linked,G[x].linkedIndices,c),P[c.shardId]||(P[c.shardId]=extension.createNoteStoreClient(c.shardId)),y&&c.businessId===y?z++:B++,P[c.shardId].authenticateToSharedNotebook(c.sharedNotebookGlobalId,w.authenticationToken,k(c.shardId,c),o(c,"authenticateToSharedNotebook")))}for(var b in a.expungedLinkedNotebooks)t(a.expungedLinkedNotebooks[b]);Persistent.set("notebooks",G),K[x].linked=a.chunkHighUSN,Persistent.set("updateCounts",K),a.updateCount===K[x].linked?(D=!0,p(),q()):f()}function j(a){for(var b in a.notebooks){var c=a.notebooks[b];r(G[x].business,G[x].businessIndices,c),s(G[x].shared,G[x].sharedIndices,c.guid,G[x].sharedOwners)}for(var b in a.expungedNotebooks)s(G[x].business,G[x].businessIndices,a.expungedNotebooks[b]);Persistent.set("notebooks",G),K[x].business=a.chunkHighUSN,Persistent.set("updateCounts",K),a.updateCount===K[x].business?(E=!0,p()):g()}function k(a,b){return function(c){c.authenticationToken?P[a].getSharedNotebookByAuth(c.authenticationToken,l(a,c,b,c.user||c.publicUserInfo),o(b,"getSharedNotebookByAuth")):y&&b.businessId===y?(A++,p()):(C++,q())}}function l(a,b,c,d){return function(e){G[x].linkedGuidToGuid[c.guid]&&G[x].linkedGuidToGuid[c.guid]!==e.notebookGuid&&(s(G[x].business,G[x].businessIndices,G[x].linkedGuidToGuid[c.guid]),s(G[x].shared,G[x].sharedIndices,G[x].linkedGuidToGuid[c.guid],G[x].sharedOwners)),G[x].linkedGuidToGuid[c.guid]=e.notebookGuid,Persistent.set("notebooks",G),y&&c.businessId===y?(A++,p()):P[a].getNotebook(b.authenticationToken,e.notebookGuid,m(d),o(c,"getNotebook"))}}function m(a){return function(b){r(G[x].shared,G[x].sharedIndices,b,G[x].sharedOwners,a),Persistent.set("notebooks",G),C++,q()}}function n(a){extension.isThriftError(a)&&a.errorCode===EDAMErrorCode.PERMISSION_DENIED&&"Business"===a.parameter?auth.updateUserStatus(function(){w=auth.getUserInfo(),w.bizAuthenticationToken||(Browser.sendToTab(c.tab,{name:(b.page?b.page+"_":"")+"receiveBusinessNotebooks",notebooks:[]}),q())}):log.error(a)}function o(a,b){return function(c){var d="Couldn't get ";d+=y&&a.businessId===y?"business":"shared",d+=" notebook: "+a.shareName+" at "+b+" because of ",extension.isThriftError(c)?(d+=c.__proto__.name,(c.errorCode||c.parameter)&&(d+="(",c.errorCode&&(d+=c.errorCode),c.parameter&&(d+=","+c.parameter),d+=")")):d+=JSON.stringify(c),log.error(d),y&&a.businessId===y?(A++,p()):(C++,q())}}function p(){if(D&&E&&A===z){var d=[];for(var e in G[x].linked){var f=G[x].linked[e],g=G[x].linkedGuidToGuid[f.guid],h=G[x].businessIndices.indexOf(g);if(h>-1){var i=G[x].business[h];i.restrictions.noCreateNotes||d.push({globalId:f.sharedNotebookGlobalId,guid:i.guid,name:f.shareName,noShareNotes:i.restrictions.noShareNotes,owner:i.contact.id!==x?i.contact.name||i.contact.username:null,shardId:f.shardId,stack:f.stack,type:a.NOTEBOOK_TYPE_BUSINESS,visibleToOthers:i.published})}}Browser.sendToTab(c.tab,{name:(b.page?b.page+"_":"")+"receiveBusinessNotebooks",alwaysStartInNotebookGuid:J,notebooks:d,recentNotebookGuid:I}),F=!0,q()}}function q(){if(D&&(!w.bizAuthenticationToken||F)&&B===C){var d=[];for(var e in G[x].linked){var f=G[x].linked[e],g=G[x].linkedGuidToGuid[f.guid];if(g){var h=G[x].sharedIndices.indexOf(g);if(h>-1){var i=G[x].shared[h];if(!i.restrictions.noCreateNotes){var j=i.contact||G[x].sharedOwners[h];d.push({globalId:f.sharedNotebookGlobalId,guid:i.guid,name:f.shareName,noShareNotes:i.restrictions.noShareNotes,owner:j.name||j.username,shardId:f.shardId,stack:f.stack,type:a.NOTEBOOK_TYPE_LINKED,visibleToOthers:!0})}}}}Browser.sendToTab(c.tab,{name:(b.page?b.page+"_":"")+"receiveSharedNotebooks",alwaysStartInNotebookGuid:J,notebooks:d,recentNotebookGuid:I})}}function r(a,b,c,d,e){var f=b.indexOf(c.guid);f>-1?(a[f]=c,d&&e&&(d[f]=e)):(a.push(c),b.push(c.guid),d&&e&&d.push(e))}function s(a,b,c,d){var e=b.indexOf(c);e>-1&&(a.splice(e,1),b.splice(e,1),d&&d.splice(e,1))}function t(a){s(G[x].linked,G[x].linkedIndices,a);var b=G[x].linkedGuidToGuid[a];delete G[x].linkedGuidToGuid[a],b&&(s(G[x].shared,G[x].sharedIndices,b,G[x].sharedOwners),s(G[x].business,G[x].businessIndices,b))}var u=1,v=50,w=auth.getUserInfo(),x=parseInt(auth.getCurrentUser()),y=w.businessId,z=0,A=0,B=0,C=0,D=!1,E=!1,F=!1,G=Persistent.get("notebooks");G||(G={}),(!G[x]||G[x].version<u)&&(G[x]={version:u}),G[x].personal||(G[x].personal=[],G[x].personalIndices=[]),G[x].linked||(G[x].linked=[],G[x].linkedIndices=[]),G[x].linkedGuidToGuid||(G[x].linkedGuidToGuid={}),G[x].shared||(G[x].shared=[],G[x].sharedIndices=[],G[x].sharedOwners=[]),w.bizAuthenticationToken&&(G[x].business||(G[x].business=[],G[x].businessIndices=[]));var H=Persistent.get("recentNotebooks");H||(H={});var I=H[x],J=null;"alwaysStartIn"===options.get("notebookSelection")&&(J=options.get("startNotebook"));var K=Persistent.get("updateCounts");K||(K={}),(!K[x]||K[x].version<u)&&(K[x]={version:u});var L=!0,M=!0,N=!0;K[x].personal||(K[x].personal=0,L=!1),K[x].linked||(K[x].linked=0,M=!1),w.bizAuthenticationToken&&(K[x].business||(K[x].business=0,N=!1));var O=extension.createNoteStoreClient(w.shardId),P={},Q=null;w.bizAuthenticationToken&&(Q=extension.createNoteStoreClient(w.bizShardId)),d()}function e(a,b){function c(){var a=auth.getUserInfo(),c=extension.createNoteStoreClient(a.shardId);if(c.listTags(a.authenticationToken,function(a){Browser.sendToTab(b.tab,{name:"receivePersonalTags",tags:a})},d),a.bizAuthenticationToken){var e=/^S=([^:]+)/.exec(a.bizAuthenticationToken)[1],f=extension.createNoteStoreClient(e);f.listTags(a.bizAuthenticationToken,function(a){Browser.sendToTab(b.tab,{name:"receiveBusinessTags",tags:a})},d)}}function d(a){console.log(a)}extension.getOption("alwaysTagWith")&&Browser.sendToTab(b.tab,{name:"receiveAlwaysTags",tags:extension.getOption("alwaysTags").split(/\s*,\s*/)}),c()}var f={};return Browser.addMessageHandlers({getNotebooks:d,getSmartFilingInfo:c,getTags:e}),f.getSmartFilingInfo=c,b&&(f.getNotebooks=d),f});