/*! Copyright 2009-2015 Evernote Corporation. All rights reserved. */
function Submitter(a,b,c,d,e){"use strict";function f(a,b,c,d,e,f){D.resources||(D.resources=[]);var i=n(a,c),j=g(a.buffer,i,d,e,f);D.resources.push(j),y+=j.data.body.byteLength,D.content=D.content.slice(0,b)+h(a.buffer,i,c)+D.content.slice(b+c.length)}function g(a,b,c,d,e){var f=new Resource;if(f.data=new Data,f.data.body=a,f.mime=b,f.attributes=new ResourceAttributes,f.attributes.sourceURL=GlobalUtils.removeControlCharacters(c),f.attributes.fileName=d,!d&&c){var g=/.+\/(.+?)(?:$|\?)/.exec(c);if(g)try{f.attributes.fileName=decodeURIComponent(g[1])}catch(h){if("URIError"!==h.name)throw h;f.attributes.fileName=unescape(g[1])}}return f.attributes.fileName&&!l(f.attributes.fileName,b)&&(f.attributes.fileName+=m(b)),f.attributes.fileName&&(f.attributes.fileName=GlobalUtils.removeControlCharacters(f.attributes.fileName)),f.attributes.attachment=!!e,f}function h(a,b,c){var d='<en-media type="',e=SparkMD5.ArrayBuffer.hash(a);d+=b+'" hash="'+e+'"';for(var f=/(?:\s|")(style|title|lang|xml:lang|dir|height|width|usemap|align|border|hspace|vspace|longdesc|alt)\s*=\s*"([^"]+)"/gi,g=f.exec(c),h=c.indexOf(">");g&&g.index<h;)""!=g[2].trim()&&(d+=" "+g[1]+'="'+g[2]+'"'),g=f.exec(c);return d+="></en-media>"}function i(a,b,c,d,e,f,g,h,i,j,k){D.attributes=new NoteAttributes,D.attributes.source="clearly"===i?"Clearly":"web.clip",D.attributes.sourceURL=GlobalUtils.removeControlCharacters(h),D.content='<?xml version="1.0" encoding="utf-8"?><!DOCTYPE en-note SYSTEM "http://xml.evernote.com/pub/enml2.dtd"><en-note>',g&&g.trim()&&(D.content+=GlobalUtils.escapeXML(g)+"<hr/>"),D.content+="<br/>"+j+"<br/></en-note>";for(var l=/<(?:img|embed|div) [^>]*?(src|evernote_attachment_url)="(data:[^>,]+,)?(resource:)?([^">]+)"[^>]*>.*?<\/(?:img|embed|div)>/g,m=l.exec(D.content),n=0;m;)m[2]?p(m[4],m.index,m[0],n++):m[3]?r(k[parseInt(m[4])],m.index,m[0],n++):q(m[4],m.index,m[0],m[1],n++),m=l.exec(D.content);D.title=a,D.notebookGuid=b,v=c,w=d,x=e,f&&f.length>0&&(D.tagNames=f),z=!0,s()}function j(b){var c;switch(b.name){case"EDAMNotFoundException":"Note.notebookGuid"==b.identifier&&(c="unknownNotebook");break;case"EDAMUserException":switch(b.errorCode){case EDAMErrorCode.BAD_DATA_FORMAT:switch(b.parameter){case"Note.content":c="noteSizeExceeded"}break;case EDAMErrorCode.LIMIT_REACHED:switch(b.parameter){case"Note":c="overAccountMax";break;case"Note.size":c="noteSizeExceeded";break;case"Note.resources":c="noteSizeExceeded";break;case"Resource.data.size":c="noteSizeExceeded"}break;case EDAMErrorCode.QUOTA_REACHED:"Accounting.uploadLimit"==b.parameter&&(c="overQuota")}}c||log.error(D.attributes.sourceURL+b.__proto__.name+JSON.stringify(b)),extension.trackEvent("noteSizeExceeded"===c?{category:"Errors",action:"Too big",label:D.attributes.sourceURL}:"overQuota"===c?{category:"Errors",action:"Over quota",label:D.attributes.sourceURL}:"overAccountMax"===c?{category:"Errors",action:"Over account max",label:D.attributes.sourceURL}:{category:"Errors",action:"Thrift: "+JSON.stringify(b).substr(0,200),label:D.attributes.sourceURL}),e({name:"fail",error:c,tokens:a})}function k(b){function c(){var c={name:"success",noteSize:y,noteGuid:b.guid,shardId:/^"?S=([^:]+)/.exec(E)[1],notebookName:v,noShareNotes:w,tokens:a,userIds:d,notebookType:x};!c.notebookName||c.noShareNotes!==!0&&c.noShareNotes!==!1?t.getNotebook(E,b.notebookGuid,function(a){c.notebookName=a.name,c.noShareNotes=a.restrictions.noShareNotes,e(c)},function(a){log.error(a.name+" "+JSON.stringify(a)),e(c)}):e(c)}console.log(b),c()}function l(a,b){return b===EDAM_MIME_TYPE_JPEG?/\.jpe?g$/.test(a):b===EDAM_MIME_TYPE_PNG?/\.png$/.test(a):b===EDAM_MIME_TYPE_GIF?/\.gif$/.test(a):b===EDAM_MIME_TYPE_PDF?/\.pdf$/.test(a):"image/webp"===b?/\.webp$/.test(a):!0}function m(a){return a===EDAM_MIME_TYPE_JPEG?".jpg":a===EDAM_MIME_TYPE_PNG?".png":a===EDAM_MIME_TYPE_GIF?".gif":a===EDAM_MIME_TYPE_PDF?".pdf":"image/webp"===a?".webp":""}function n(a,b){if(b){var c=/evernote_attachment_mime="([^"]+)"/.exec(b);if(c&&c[1]!==EDAM_MIME_TYPE_DEFAULT&&new RegExp(EDAM_MIME_REGEX).test(c[1]))return c[1]}if(255===a[0]&&216===a[1]&&255===a[2])return EDAM_MIME_TYPE_JPEG;if(137===a[0]&&80===a[1]&&78===a[2]&&71===a[3]&&13===a[4]&&10===a[5]&&26===a[6]&&10===a[7])return EDAM_MIME_TYPE_PNG;if(0===a[0]&&0===a[1]&&1===a[2]&&0===a[3])return EDAM_MIME_TYPE_PNG;if(71===a[0]&&73===a[1]&&70===a[2]&&56===a[3]&&(55===a[4]||57===a[4])&&97===a[5])return EDAM_MIME_TYPE_GIF;if(37===a[0]&&80===a[1]&&68===a[2]&&70===a[3])return EDAM_MIME_TYPE_PDF;if(82===a[0]&&73===a[1]&&70===a[2]&&70===a[3]&&87===a[8]&&69===a[9]&&66===a[10]&&80===a[11])return"image/webp";if(208===a[0]&&207===a[1]&&17===a[2]&&224===a[3]&&161===a[4]&&177===a[5]&&26===a[6]&&225===a[7]){if(236===a[512]&&165===a[513]&&193===a[514]&&0===a[515])return"application/msword";if(0===a[512]&&110===a[513]&&30===a[514]&&240===a[515]||15===a[512]&&0===a[513]&&232===a[514]&&3===a[515]||160===a[512]&&70===a[513]&&29===a[514]&&240===a[515])return"application/mspowerpoint";if(9===a[512]&&8===a[513]&&16===a[514]&&0===a[515]&&0===a[516]&&6===a[517]&&5===a[518]&&0===a[519]||253===a[512]&&255===a[513]&&255===a[514]&&255===a[515]&&32===a[516]&&0===a[517]&&0===a[518]&&0===a[519])return"application/excel"}else if(80===a[0]&&75===a[1]&&3===a[2]&&4===a[3]){var d=OOXMLReader.getFileType(a);if(d===OOXMLReader.DOCX)return"application/vnd.openxmlformats-officedocument.wordprocessingml.document";if(d===OOXMLReader.PPTX)return"application/vnd.openxmlformats-officedocument.presentationml.presentation";if(d===OOXMLReader.XLSX)return"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}return EDAM_MIME_TYPE_DEFAULT}function o(){u=/^"?S=(s\d+)/.exec(E)[1];var a=new Thrift.BinaryHttpTransport(c+"/edam/note/"+u),b=new Thrift.BinaryProtocol(a);t=new NoteStoreClient(b)}function p(a,b,c,d){for(var e=decodeURIComponent(a).split("&")[0],f=window.atob(e),g=new Uint8Array(2*f.length),h=0;h<f.length;h++)g[h]=f.charCodeAt(h);C[d]={byteArray:g,loc:b,orig:c}}function q(a,b,c,d,e){a=GlobalUtils.unescapeXML(a);var f=new XMLHttpRequest;f.open("GET",a),f.responseType="arraybuffer",f.url=a,f.original=c,f.loc=b,f.index=e,A++,f.onreadystatechange=function(){4===this.readyState&&(200===this.status&&this.response&&this.response.byteLength>0?(C[this.index]={byteArray:new Uint8Array(this.response),loc:this.loc,orig:this.original,url:this.url},"evernote_attachment_url"===d&&(C[this.index].attachment=!0,C[this.index].fileName=/evernote_attachment_name="([^"]*)"/.exec(c)[1])):C[this.index]={loc:this.loc,orig:this.original},B++,s())};try{f.send()}catch(g){}}function r(a,b,c,d){a.bytes.length=a.byteLength,C[d]={byteArray:new Uint8Array(a.bytes),loc:b,orig:c,url:D.attributes.sourceURL}}function s(){if(z&&A===B){for(var a=C.length-1;a>=0;a--)C[a]&&(C[a].byteArray?f(C[a].byteArray,C[a].loc,C[a].orig,C[a].url,C[a].fileName,C[a].attachment):/(evernote_attachment|^<embed)/.test(C[a].orig)&&(D.content=D.content.slice(0,C[a].loc)+D.content.slice(C[a].loc+C[a].orig.length)));if(D.content=GlobalUtils.removeControlCharacters(D.content,!0),D.content.length>EDAM_NOTE_CONTENT_LEN_MAX){var c=new EDAMUserException;return c.errorCode=EDAMErrorCode.BAD_DATA_FORMAT,c.parameter="Note.content",void j(c)}if(y+=D.content.length,y>b.noteSizeMax){var c=new EDAMUserException;return c.errorCode=EDAMErrorCode.LIMIT_REACHED,c.parameter="Note.size",void j(c)}if(e({name:"showSyncing"}),"noteSizeExceeded"===extension.getOption("simulateClippingError")){var c=new EDAMUserException;c.errorCode=EDAMErrorCode.LIMIT_REACHED,c.parameter="Note.size",j(c)}else if("overQuota"===extension.getOption("simulateClippingError")){var c=new EDAMUserException;c.errorCode=EDAMErrorCode.QUOTA_REACHED,c.parameter="Accounting.uploadLimit",j(c)}else if("overAccountMax"===extension.getOption("simulateClippingError")){var c=new EDAMUserException;c.errorCode=EDAMErrorCode.LIMIT_REACHED,c.parameter="Note",j(c)}else t.createNote(E,D,k,j)}}{var t,u,v,w,x,y=0,z=!1,A=0,B=0,C=[],D=new Note,E=a.submit;d.submit}this.createNoteWithThrift=i,Object.preventExtensions(this),o()}Object.preventExtensions(Submitter);