/*! Copyright 2009-2015 Evernote Corporation. All rights reserved. */
function ClipResultBackground(){"use strict";function a(a,b){var c=document.getElementById("copier");c.value=a.text,c.select(),Browser.sendToTab(b.tab,{name:"sh_urlCopied",copied:document.execCommand("copy",!1,null)})}function b(a){function b(){e=new JsonRpc(null,["NoteStore.emailNote","NoteStoreExtra.emailNotesSharedWorkaround"],null,options.get("secureProto"),extension.getBootstrapInfo("serviceHost"),options.get("overrideServiceURL")),e.initWithAuthToken(a.token,c)}function c(){a.shared?e.client.NoteStoreExtra.emailNotesSharedWorkaround(d,a.token,auth.getUserInfo().authenticationToken,{javaClass:"java.util.ArrayList",list:a.recipients},{javaClass:"java.util.ArrayList",list:[a.noteGuid]},a.message):e.client.NoteStore.emailNote(d,a.token,{guid:a.noteGuid,toAddresses:{javaClass:"java.util.ArrayList",list:a.recipients},message:a.message})}function d(a,b){b&&log.error(b)}var e;b()}function c(a,b){function c(c){for(var d=[],e=0;e<c.length;e++)c[e].type===ContactType.EMAIL&&d.push({name:c[e].name,email:c[e].id});Browser.sendToTab(b.tab,{name:"sh_receiveContacts",contacts:d,count:a.count})}function d(a){log.error(a)}auth.isAuthenticated(function(b){b?extension.createNoteStoreClient(b.shardId).findContacts(b.authenticationToken,new ContactsQuery({maxEntries:5,prefix:a.prefix}),c,d):log.error("not logged in while finding contacts")})}function d(a,b){function c(a){Browser.sendToTab(b.tab,{name:"cr_receiveRelatedNotes",relatedNotes:a})}var e=extension.getPendingNote(a.pendingNoteKey);if(e&&e.relatedNotes){var f=null;auth.getUserInfo().bizAuthenticationToken&&(f=/S=([^:]+)/.exec(auth.getUserInfo().bizAuthenticationToken)[1]),c(extension.combineRelatedNotes(e.relatedNotes.pers,auth.getUserInfo().shardId,e.relatedNotes.biz,f,e.relatedNotes.containingNotebooks))}else a.recText?sidebarBackground.getSmartFilingInfo({notesOnly:!0,pendingNoteKey:a.pendingNoteKey,recText:a.recText,url:a.url,callback:function(a,b){d({pendingNoteKey:a},b)}},b):c([])}function e(a,b,c){function d(a){a.name="cr_receiveSameSiteNotes",Browser.sendToTab(b.tab,a)}function e(a){m=a,(j.bizAuthenticationToken&&n||!j.bizAuthenticationToken)&&d(g())}function f(a){n=a,m&&d(g())}function g(){for(var a=0;a<m.notes.list.length;a++)m.notes.list[a].shardId=k.shardId;if(j.bizAuthenticationToken){for(var a=0;a<n.notes.list.length;a++)n.notes.list[a].shardId=l.shardId,n.notes.list[a].inBusinessNotebook=!0,m.notes.list.push(n.notes.list[a]);m.notes.list.sort(function(a,b){return b.updated-a.updated})}return m}function h(){k.client.NoteStoreExtra.findNotesWithSnippet(e,j.authenticationToken,p,0,q,o),j.bizAuthenticationToken&&l.client.NoteStoreExtra.findNotesWithSnippet(f,j.bizAuthenticationToken,p,0,q,o)}function i(a){if(j=a,!j||!j.authenticationToken)return void d(null);var b=options.get("secureProto")+extension.getBootstrapInfo("serviceHost");k=new JsonRpc(null,["NoteStoreExtra.findNotesWithSnippet"],b,options.get("secureProto"),extension.getBootstrapInfo("serviceHost"),options.get("overrideServiceURL")),k.initWithAuthToken(j.authenticationToken,function(){j.bizAuthenticationToken?(l=new JsonRpc(null,["NoteStoreExtra.findNotesWithSnippet"],b,options.get("secureProto"),extension.getBootstrapInfo("serviceHost"),options.get("overrideServiceURL")),l.initWithAuthToken(j.bizAuthenticationToken,h)):h()})}var j,k,l,m,n,o=a.resultSpec,p=a.noteFilter,q=10;auth.isAuthenticated(i),c&&c()}function f(a,b){a.name="cr_initialize",a.baseUrl=options.get("secureProto")+extension.getBootstrapInfo("serviceHost"),a.locale=extension.getBootstrapInfo("name"),a.userId=auth.getCurrentUser(),a.afterClip=options.get("afterClip"),a.basic=auth.getUserInfo().basic,a.plus=auth.getUserInfo().plus,a.premium=auth.getUserInfo().premium,a.noteSizeMax=auth.getUserInfo().noteSizeMax,a.quota=auth.getUserInfo().quota,a.userNoteCountMax=auth.getUserInfo().userNoteCountMax,Browser.sendToTab(b.tab,a)}function g(a){function b(a){log.error(a)}var c=new NoteAttributes({source:"web.clip",sourceURL:a.sourceURL,reminderOrder:a.reminderOrder});a.reminderTime&&(c.reminderTime=a.reminderTime),extension.createNoteStoreClient(a.shardId).updateNote(a.token,new Note({guid:a.noteGuid,title:a.title,attributes:c}),function(){},b)}function h(b,c){function d(d){var e=options.get("secureProto")+extension.getBootstrapInfo("serviceHost")+"/shard/"+f+"/sh/"+b.guid+"/"+d;Browser.sendToTab(c.tab,{name:"sh_complete",url:e}),"url"===b.shareType&&a({text:e},c)}function e(a){log.error(a)}var f=null;f=/S=(s\d+):/.exec(b.token)[1],extension.createNoteStoreClient(f).shareNote(b.token,b.guid,d,e)}Browser.addMessageHandlers({copyText:a,emailNote:b,findContacts:c,getRelatedNotes:d,getSameSiteNotes:e,initializeClipResult:f,setReminder:g,shareNote:h}),Object.preventExtensions(this)}Object.preventExtensions(ClipResultBackground);