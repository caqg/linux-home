/*! Copyright 2009-2015 Evernote Corporation. All rights reserved. */
function WorkchatBackground(){"use strict";function a(a,b){B&&B.removeTab(b.tab)}function b(a){var b=new Thrift.BinaryHttpTransport(extension.getOption("secureProto")+extension.getBootstrapInfo("serviceHost")+"/shard/"+a+"/messagestore"),c=new Thrift.BinaryProtocol(b);return new MessageStoreClient(c)}function c(a,b){var c=/^<msg>(.+?)<\/msg>$/i.exec(a);return c?b?c[1].replace(x,function(a,b,c){if(z.test(b))return a.replace(/<a /,'<a target="_blank" ');var d=y.exec(c);if(d){d=d[0];var e=c.split(d);return c=e.shift(),b+"<a href='"+c+"' target='_blank'>"+c+"</a>"+d+e.join(d)}return b+"<a href='"+c+"' target='_blank'>"+c+"</a>"}):c[1].replace(A,"$1"):""}function d(a){var b=auth.getCurrentUser(),c=[],d=Persistent.get("userIdToIdentityId"),e=Persistent.get("userIdToEmail"),f=Persistent.get("emailToIdentityId"),g=Persistent.get("identities");if(a.userId&&d&&d[b]&&e&&e[b]&&f&&f[b]&&g&&g[b])if(a.contact.type===ContactType.EMAIL){var h=d[b][a.userId];h&&g[b][h]&&c.push(g[b][h])}else if(a.contact.type===ContactType.EVERNOTE){var i=e[b][a.userId];if(i){var h=f[b][i];h&&g[b][h]&&c.push(g[b][h])}}return c}function e(a,b){var c=auth.getCurrentUser();if(c){var d=Persistent.get("emailToUserId"),e=Persistent.get("userIdToIdentityId"),f=Persistent.get("identities");if(d&&d[c]&&e&&e[c]&&f&&f[c]){var g=d[c][a.email];if(g){var h=e[c][g];if(h){var i=f[c][h];Browser.sendToTab(b.tab,{name:"updateEmailContactWithUserId",email:a.email,user:{id:g,name:i.contact.name}})}}}}}function f(a){var b=auth.getCurrentUser(),c=Persistent.get("identities");if(c&&c[b]){var d=g(a);if(c[b][d])return c[b][d]}return null}function g(a){var b=auth.getCurrentUser(),c=Persistent.get("userIdToIdentityId"),d=Persistent.get("emailToUserId"),e=Persistent.get("emailToIdentityId"),f=null;if(c&&c[b]&&d&&d[b]&&e&&e[b])if(a.type===ContactType.EVERNOTE){var g=a.id;f=c[b][g]}else if(a.type===ContactType.EMAIL){var h=a.id,g=d[b][h];f=g?c[b][g]:e[b][h]}return f}function h(a,b,c){function d(a,b){for(var c=0;c<a.length;c++){var d=g(a[c]);if(!d||b.messageThread.participantIds.indexOf(d)<0)return!1}return!0}var e=auth.getCurrentUser();if(e){var f=[],h=Persistent.get("userIdToIdentityId"),i=Persistent.get("emailToUserId"),j=Persistent.get("emailToIdentityId"),k=Persistent.get("identities"),l=Persistent.get("threads");if(h&&h[e]&&i&&i[e]&&j&&j[e]&&k&&k[e]&&l&&l[e])for(var n=0;n<a.contacts.length;n++){var o=g(a.contacts[n]);if(o)for(var p=k[e][o].threadIds,q=0;q<p.length;q++)l[e][p[q]].messageThread.participantIds.length>2&&f.indexOf(p[q])<0&&d(a.requiredContacts,l[e][p[q]])&&f.push(p[q])}m({threadIds:f,contactSearchNum:a.contactSearchNum},b,c)}}function i(a,b){var c=auth.getCurrentUser();if(c){var e=null,f=Persistent.get("userIdToIdentityId"),g=Persistent.get("emailToUserId"),h=Persistent.get("emailToIdentityId"),i=Persistent.get("identities"),j=Persistent.get("threads"),k=[],l=null;if(i&&i[c]&&j&&j[c]){f&&f[c]||(f={},f[c]={}),g&&g[c]||(g={},g[c]={}),h&&h[c]||(h={},h[c]={});for(var m=0;m<a.contacts.length;m++){var n=null;if(a.contacts[m].type===ContactType.EVERNOTE)n=f[c][a.contacts[m].id];else if(a.contacts[m].type===ContactType.EMAIL){var o=g[c][a.contacts[m].id];n=o?f[c][o]:h[c][a.contacts[m].id]}if(!n){l=[];break}for(var p=i[c][n],q=p.threadIds||[],r=d(p),s=0;s<r.length;s++)r[s].threadIds&&r[s].threadIds.length&&(q=q.concat(r[s].threadIds));if(k.length)k.push(q);else{k.push([]);for(var s=0;s<q.length;s++)k[0].indexOf(q[s])<0&&j[c][q[s]].messageThread.participantIds.length===a.contacts.length+1&&k[0].push(q[s])}}if(k.length||(l=[]),l||(l=k[0].filter(function(a){for(var b=1;b<this.length;b++)if(this[b].indexOf(a)<0)return!1;return!0},k)),l.length){e={id:l[0],participants:[]};for(var t=j[c][e.id].messageThread.participantIds,s=0;s<t.length;s++){var p=i[c][t[s]];p.userId!=c&&e.participants.push({id:p.contact.id,name:p.contact.name,type:p.contact.type})}}}Browser.sendToTab(b.tab,{name:"receiveThreadByGivenContacts",thread:e,updateViewNum:a.updateViewNum})}}function j(a){var b=auth.getCurrentUser(),c=Persistent.get("userProfiles"),d=Persistent.get("emailToUserId");if(c&&c[b]&&d&&d[b])if(a.type===ContactType.EMAIL){var e=d[b][a.id];if(e)return c[b][e]}else if(a.type===ContactType.EVERNOTE){var e=a.id-0;if(c[b][e])return c[b][e]}return null}function k(a,b){function c(){for(var c=[],d=0;d<i.length;d++)if(i[d].type===ContactType.EMAIL){var e=j(i[d]);if(e){e.id!=auth.getCurrentUser()&&c.push({id:e.id,name:e.name,email:e.email,photoUrl:e.photoUrl,role:e.attributes?e.attributes.title:null,sameBusiness:!0,type:ContactType.EVERNOTE});continue}var g=f(i[d]);if(g){g.contact.type===ContactType.EVERNOTE?g.contact.id!=auth.getCurrentUser()&&c.push({id:g.contact.id,name:g.contact.name,email:i[d].id,photoUrl:g.contact.photoUrl,sameBusiness:g.sameBusiness,type:ContactType.EVERNOTE}):c.push(g.contact.type===ContactType.EMAIL?{id:i[d].id,name:i[d].name,email:i[d].id,type:ContactType.EMAIL}:{id:i[d].id,name:i[d].name,email:i[d].id,type:ContactType.EMAIL});continue}for(var h=null,l=0;l<k.length;l++)if(i[d].id===k[l].email){h=k[l];break}if(h){c.push({id:i[d].id,name:i[d].name,email:i[d].id,photoUrl:h.photoUrl,google:!0,type:ContactType.EMAIL});continue}c.push({id:i[d].id,name:i[d].name,email:i[d].id,type:ContactType.EMAIL})}else if(i[d].type===ContactType.EVERNOTE){var e=j(i[d]);e?e.id!=auth.getCurrentUser()&&c.push({id:e.id,name:e.name,email:e.email,photoUrl:e.photoUrl,role:e.attributes?e.attributes.title:null,sameBusiness:!0,type:ContactType.EVERNOTE}):i[d].id!=auth.getCurrentUser()&&c.push({id:i[d].id,name:i[d].name,photoUrl:i[d].photoUrl,type:ContactType.EVERNOTE})}Browser.sendToTab(b.tab,{name:"receiveContacts",contacts:c,contactSearchNum:a.contactSearchNum})}var d=auth.getCurrentUser();if(d){var e=auth.getUserInfo(),g=extension.createNoteStoreClient(e.shardId),h=new ContactsQuery({maxEntries:v,prefix:a.query}),i=null,k=null;g.findContacts(e.authenticationToken,h,function(a){i=a,k&&c()},function(a){console.log(a),i=[],k&&c()});var l=Persistent.get("googleConnection");if(l&&l[d]&&l[d].connected){var m=new JsonRpc(null,["NoteStoreExtra.getGoogleContacts"],extension.getOption("secureProto")+extension.getBootstrapInfo("serviceHost"),extension.getOption("secureProto"),extension.getBootstrapInfo("serviceHost"),extension.getOption("overrideServiceURL"));m.initWithAuthToken(e.authenticationToken,function(){m.client.NoteStoreExtra.getGoogleContacts(function(a,b){a?k=a.contacts&&a.contacts.list?a.contacts.list:[]:(console.log(b),k=[]),i&&c()},e.authenticationToken,null,h.prefix,5)})}else k=[],i&&c()}}function l(a,b){var d=auth.getCurrentUser();if(d){for(var e=Persistent.get("threads"),f=Persistent.get("messages"),g=Persistent.get("identities"),h=Persistent.get("userIdToIdentityId"),i=e[d][a.threadId],j=i.messageThread.messageIds||[],k=[],l=0;l<j.length;l++)if(!(j[l]<=(a.afterMessageId||0))){var m=f[d][j[l]],n=g[d][h[d][m.senderId]];k.push({attachments:m.attachments,body:c(m.body,!0),id:m.id,sender:{name:n.contact.name,photoUrl:n.contact.photoUrl,self:d==m.senderId,id:m.senderId},time:m.sentAt})}Browser.sendToTab(b.tab,{name:"receiveMessagesOfThread",authToken:auth.getUserInfo().authenticationToken,baseUrl:extension.getOption("secureProto")+extension.getBootstrapInfo("serviceHost"),lastReadMessageId:i.lastReadMessageId,threadId:a.threadId,messages:k,update:a.afterMessageId?!0:!1,updateViewNum:a.updateViewNum})}}function m(a,b){var c=auth.getCurrentUser();if(c){var d=Persistent.get("threads");if(d&&d[c]){var e=[];if(a.threadIds)for(var f=0;f<a.threadIds.length;f++){var g=d[c][a.threadIds[f]];g&&e.push(g.messageThread)}else{for(var h in d[c])e.push(d[c][h].messageThread);e.sort(function(a,b){return a.lastMessageSentAt>b.lastMessageSentAt?-1:a.lastMessageSentAt<b.lastMessageSentAt?1:0})}for(var i=[],k=Persistent.get("identities"),f=0;f<e.length;f++)if(e[f].messageIds&&e[f].messageIds.length){for(var l=e[f].participantIds,m=[],n=[],o=0;o<l.length;o++){var p=l[o];if(k[c][p].userId!=c){var q=k[c][p].contact,r=j(q);m.push({id:q.id,name:q.name,type:q.type,sameBusiness:!!r}),n.push(q.photoUrl)}}if(i.push({id:e[f].id,snippet:e[f].snippet,participants:m,photos:n}),i.length===u)break}Browser.sendToTab(b.tab,{name:"receiveThreads",threads:i,contactSearchNum:a.contactSearchNum})}}}function n(a,b){var c=auth.getCurrentUser();if(c){var d=Persistent.get("googleConnection");d&&d[c]&&d[c].connected?Browser.sendToTab(b.tab,{name:"isGoogleConnected",connected:!0}):Browser.sendToTab(b.tab,{name:"isGoogleConnected",connected:!1,connectUrl:extension.getOption("secureProto")+extension.getBootstrapInfo("serviceHost")+"/GoogleData.action?connect&oauthSourcePage=connectedServices"})}}function o(a,b){if(window.WebSocket){var c=auth.getUserInfo().shardId,d=auth.getUserInfo().authenticationToken;(!B||B.getShardId()!==c||B.getAuthToken()!==d||B.isClosed())&&(B=new WebSocketManager(c,d,function(a){if(a.messageNotification){var b=auth.getCurrentUser(),c=auth.getUserInfo();C&&C.getAuthToken()===c.authenticationToken||(C=q(b,c)),C.setSyncCompleteHandler(function(){for(var a=B.getTabs(),b=0;b<a.length;b++)Browser.sendToTab(a[b],{name:"updateView"})});var d=Persistent.get("messageEventUSN");!d||!d[b]||a.messageNotification.previousEventId>d[b]?C.sync():C.applySyncChunk(a.messageNotification.syncChunk)}})),B.addTabs(b.tab)}}function p(a){function c(a){console.log(a)}function d(a){console.log(a)}function e(){a.threadRecipient?(j.messageThreadId=a.threadRecipient,i.sendMessageToThread(h.authenticationToken,j,c,function(a){"EDAMSystemException"===a.__proto__.name&&a.errorCode===EDAMErrorCode.UNSUPPORTED_OPERATION?f():d(a)})):i.createMessageThread(h.authenticationToken,new CreateMessageThreadSpec({message:j,participants:m,groupThread:m.length+1>2}),c,function(a){"EDAMSystemException"===a.__proto__.name&&a.errorCode===EDAMErrorCode.UNSUPPORTED_OPERATION?f():d(a)})}function f(){var b=new Destination;a.threadRecipient?b.messageThreadId=a.threadRecipient:b.recipients=m,i.sendMessage(h.authenticationToken,j,b,c,d)}var g=auth.getCurrentUser();if(g){var h=auth.getUserInfo(),i=b(h.shardId);a.body=GlobalUtils.escapeXML(a.body).replace(/\n/g,"<br/>");var j=new Message({body:"<msg>"+a.body+"</msg>"});if(a.attachments&&a.attachments.length){j.attachments=[];for(var k=0;k<a.attachments.length;k++){var l=new MessageAttachment({guid:a.attachments[k].guid,shardId:a.attachments[k].shardId,title:a.attachments[k].title,type:MessageAttachmentType.NOTE,userId:a.attachments[k].userId-0});j.attachments.push(l)}}for(var m=[],k=0;k<a.contactRecipients.length;k++)m.push(new Contact({id:a.contactRecipients[k].id,type:a.contactRecipients[k].type}));if(j.attachments&&j.attachments[0]){var n=extension.createNoteStoreClient(a.noteShardId);n.createOrUpdateSharedNotes(a.noteToken,new SharedNoteTemplate({noteGuid:j.attachments[0].guid,recipients:m,privilege:a.noteSharePrivilege}),e,function(a){console.log(a)})}else e()}}function q(a,d){return new Syncer(a,d.authenticationToken,"messageEvent",[{name:"identities",idPropertyChain:["id"],updateItem:function(a,b){return a&&(b.threadIds=a.threadIds),b},extraHandling:function(b){if(b.userId){if(b.contact.type===ContactType.EVERNOTE){var c=Persistent.get("userIdToIdentityId");c||(c={}),c[a]||(c[a]={}),c[a][b.userId]||(c[a][b.userId]=b.id,Persistent.set("userIdToIdentityId",c))}else if(b.contact.type===ContactType.EMAIL){var d=Persistent.get("emailToUserId");d||(d={}),d[a]||(d[a]={}),d[a][b.contact.id]=b.userId,Persistent.set("emailToUserId",d);var e=Persistent.get("userIdToEmail");e||(e={}),e[a]||(e[a]={}),e[a][b.userId]=b.contact.id,Persistent.set("userIdToEmail",e);var f=Persistent.get("emailToIdentityId");f||(f={}),f[a]||(f[a]={}),f[a][b.contact.id]=b.id,Persistent.set("emailToIdentityId",f)}}else if(b.contact.type===ContactType.EVERNOTE);else if(b.contact.type===ContactType.EMAIL){var f=Persistent.get("emailToIdentityId");f||(f={}),f[a]||(f[a]={}),f[a][b.contact.id]=b.id,Persistent.set("emailToIdentityId",f)}return{}}},{name:"threads",idPropertyChain:["messageThread","id"],updateItem:function(a,b){return a&&(b.messageThread.messageIds=a.messageThread.messageIds,b.messageThread.lastMessageSentAt=a.messageThread.lastMessageSentAt,b.messageThread.snippet=a.messageThread.snippet),b},extraHandling:function(b,c){var d={};if(b.maxDeletedMessageId){var e=Persistent.get("messages");if(e&&e[a]&&b.messageThread.messageIds){for(;b.messageThread.messageIds.length;){var f=b.messageThread.messageIds[0];if(!(f<=b.maxDeletedMessageId))break;delete e[a][f],b.messageThread.messageIds.shift()}d.item=b,d.messages=e[a]}}for(var g=b.messageThread.id,h=0;h<b.messageThread.participantIds.length;h++){var i=b.messageThread.participantIds[h];c.identities[i].threadIds||(c.identities[i].threadIds=[]),c.identities[i].threadIds.indexOf(g)<0&&(c.identities[i].threadIds.push(g),d.identities=c.identities)}return d}},{name:"messages",idPropertyChain:["id"],updateItem:function(a,b){return b},extraHandling:function(a,b){var d=b.threads,e=d[a.messageThreadId].messageThread.lastMessageSentAt||0;if(a.sentAt>=e){d[a.messageThreadId].messageThread.lastMessageSentAt=a.sentAt,d[a.messageThreadId].messageThread.snippet=c(a.body,!1),a.id>d[a.messageThreadId].maxDeletedMessageId&&(d[a.messageThreadId].messageThread.messageIds||(d[a.messageThreadId].messageThread.messageIds=[]),d[a.messageThreadId].messageThread.messageIds.push(a.id));var f={threads:d};return a.id<=d[a.messageThreadId].maxDeletedMessageId&&(f.item=null),f}return{}}}],"chunkMaxEventId","userMaxEventId",function(a,c,e){var f=b(d.shardId);f.getMessageSyncChunk(d.authenticationToken,new MessageSyncFilter({afterEventId:a}),c,e)})}function r(a,b){var c=auth.getCurrentUser();if(c){var d=auth.getUserInfo();C&&C.getAuthToken()===d.authenticationToken||(C=q(c,d)),C.setSyncCompleteHandler(function(){a&&a.responseName&&b&&b.tab&&Browser.sendToTab(b.tab,{name:a.responseName})}),C.sync(),d.bizAuthenticationToken&&s()}}function s(){var a=auth.getCurrentUser(),b=auth.getUserInfo().bizAuthenticationToken,c=Persistent.get("businessUsersSynced");if(!c||!c[a]||c[a].version<w||c[a].lastDay+864e5+c[a].offset<=new Date){var d=extension.createUserStoreClient(/S=(.+?):/.exec(b)[1]);d.listBusinessUsers(b,function(a){var b=auth.getCurrentUser(),c=Persistent.get("emailToUserId");c||(c={}),c[b]||(c[b]={});var d=Persistent.get("userIdToEmail");d||(d={}),d[b]||(d[b]={});var e=Persistent.get("userProfiles");e||(e={}),e[b]||(e[b]={});for(var f=0;f<a.length;f++)e[b][a[f].id]=a[f],c[b][a[f].email]=a[f].id,d[b][a[f].id]=a[f].email;Persistent.set("emailToUserId",c),Persistent.set("userIdToEmail",d),Persistent.set("userProfiles",e);var g=Persistent.get("businessUsersSynced");g||(g={}),g[b]||(g[b]={}),g[b].version=w;var h=new Date;g[b].lastDay=new Date(h.getFullYear(),h.getMonth(),h.getDate())-0,g[b].offset&&(g[b].offset=Math.floor(24*Math.random()*60*60*1e3)),Persistent.set("businessUsersSynced",g)},function(a){console.log(a)})}}function t(a){var c=b(auth.getUserInfo().shardId);c.updateReadStatus(auth.getUserInfo().authenticationToken,a.threadId,a.messageId,function(a){console.log(a)},function(a){console.log(a)})}var u=3,v=10,w=1,x=/(.*?)(https?:\/\/\S+)/gi,y=/'|&#x27;|"|&quot;|\(|\)|<|&lt;|&#x3c;|&#60;|>|&gt;|&#x3e;|&#62;/i,z=/<a\s+href\s*=\s*['"]\s*$/i,A=/<a\s+href\s*=\s*['"][^'"]+['"][^>]*>([^<]*)<\/a>/gi,B=null,C=null;Browser.addMessageHandlers({closeWebSocket:a,findContactByEmail:e,findThreads:h,findThreadByGivenContacts:i,findWorkchatContacts:k,getMessagesOfThread:l,getThreads:m,isGoogleConnected:n,openWebSocket:o,sendChat:p,syncMessages:r,updateThreadReadStatus:t}),this.sync=r,Object.preventExtensions(this)}Object.preventExtensions(WorkchatBackground);