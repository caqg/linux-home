/*! Copyright 2009-2015 Evernote Corporation. All rights reserved. */
function Bootstrapper(a,b,c,d){"use strict";function e(a){w=new JsonRpc(null,["UserStore.checkVersion","UserStore.getBootstrapInfo"],null,d,q.get("serviceHost"),c);var b=c.trim();""!==b&&(u=[b,b]),w.initWithUrl(d+u[a]+"/json");var e=new Date,h=e.getUTCMonth()+1<=9?"0"+(e.getUTCMonth()+1):(e.getUTCMonth()+1).toString(),i=h+e.getUTCDate().toString()+e.getUTCFullYear().toString(),j=Persistent.get("checkedVersion");j||(j={}),j[i]||(j[i]={});for(var k in j)k!==i&&delete j[k];Persistent.set("checkedVersion",j);var l=parseInt(Persistent.get("deviceID").substr(0,3),16)%1440,m=60*e.getUTCHours()+e.getUTCMinutes();if(t++,(void 0===j[i][u[a]]||null===j[i][u[a]])&&m>=l){j[i][u[a]]=!0,Persistent.set("checkedVersion",j);var n=GlobalUtils.generateSystemInfo(),o="EvernoteClipper/"+Browser.EVERNOTE_VERSION+"; "+n.browser.replace(" ","/")+"; "+n.os.replace(" ","/");w.client.UserStore.checkVersion(function(b,c){c&&"number"==typeof c.code&&200!=c.code||(j[i][u[a]]=b,Persistent.set("checkedVersion",j)),g(b,c)},o,EDAM_VERSION_MAJOR,EDAM_VERSION_MINOR),y&&(x=setTimeout(f,3e3))}else g(void 0===j[i][u[a]]||null===j[i][u[a]]?!0:j[i][u[a]])}function f(){x&&clearTimeout(x),w.client.UserStore.getBootstrapInfo(h,m),x=setTimeout(h,3e3)}function g(a,b){b&&("number"==typeof b.code&&200!=b.code?(log.warn("HTTP Error checking version. Assuming OK."),a=!0):log.log("Error checking version: "+JSON.stringify(b))),a===!0?y?f():i(p):(p=!1,alert(Browser.i18n.getMessage("checkVersionWarning")),i(p))}function h(a){if(x&&clearTimeout(x),a&&a.profiles&&a.profiles.list){a=a.profiles.list;for(var b=0,c=q.getName(),d=0;d<a.length;d++)"undefined"!=typeof a[d].name&&a[d].name===c&&(b=d);Persistent.set("BootstrapInfoIndex",b),Persistent.set("BootstrapInfo",a)}else{if(!(t>=2))return void e(s);log.error("Couldn't contact either bootstrap server. Using what we've got...")}i(p),o=!1}function i(a){for(var b=n.length-1;b>=0;b--){try{n[b](a)}catch(c){log.error("Error running callback: "+c.message+c.stack)}n.pop()}n=[]}function j(a,b){return a&&n.push(a),navigator.onLine?void(o||(y=b,e(r),o=!0)):(log.log("Bootstrapping while offline, will use existing info."),void i(p))}var k="zh-CN",l=!1,m=navigator.language;a&&(log.log("Will simulate Simplified Chinese."),l=!0,m=k);var n=[],o=!1,p=!0,q=new BootstrapInfo(c),r=0;m===k&&(r=1);var s=r?0:1,t=0,u=["www.evernote.com","app.yinxiang.com"],v=["stage.evernote.com","stage-china.evernote.com"];b&&(u=v);var w,x,y=!0;this.bootstrap=j,Object.preventExtensions(this)}function BootstrapInfo(a){function b(b){if("name"==b)return c();if("serviceHost"==b){var e=a;if(e&&(e=e.trim()),e)return log.log("Using overidden serviceHost: "+e),e}if("undefined"==typeof i[b])return log.error("Invalid Bootstrap Info Key: "+b),!1;var f=d(),g=Persistent.get(h);return g&&g.length>f&&g[f].settings?g[f].settings[b]:i[b]}function c(){var a=d(),b=Persistent.get(h);return b&&b.length>a&&"undefined"!=typeof b[a].name?b[a].name:""}function d(){var a=Persistent.get(g);return a?a:0}function e(a){Persistent.set(g,a);var b=d();a!==b&&Persistent.clear("savedAuthInfo")}function f(){var a=Persistent.get(h);return a&&a.length?a.length:0}var g="BootstrapInfoIndex",h="BootstrapInfo",i={serviceHost:"www.evernote.com",marketingUrl:"http://www.evernote.com",supportUrl:"https://support.evernote.com",accountEmailDomain:"www.evernote.com",enableFacebookSharing:!0,enableGiftSubscriptions:!0,enableSharedNotebooks:!0,enableSingleNoteSharing:!0,enableSponsoredAccounts:!0,enableSupportTickets:!0,enableTwitterSharing:!0};this.getIndex=d,this.setIndex=e,this.getLength=f,this.get=b,this.getName=c,Object.preventExtensions(this)}Object.preventExtensions(Bootstrapper),Object.preventExtensions(BootstrapInfo);