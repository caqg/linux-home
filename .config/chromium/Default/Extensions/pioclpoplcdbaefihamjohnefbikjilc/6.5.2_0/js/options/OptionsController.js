/*! Copyright 2009-2015 Evernote Corporation. All rights reserved. */
function OptionsController(){"use strict";function a(){var a={};for(var b in y)a[y[b]]=!1;for(var b in z)a[z[b]]=!1;for(var b in A)a[A[b]]=!1;for(var b in C)a[C[b]]=!1;for(var b in B)a[B[b]]=!1;Browser.sendToExtension({name:"main_getConfig",options:a,returnName:"options_config"})}function b(a){if(a.options){GlobalUtils.localize(document.body),GlobalUtils.localize(document.getElementsByTagName("title")[0]);for(var b in y){var c=y[b],i=document.getElementById(c);i.checked=a.options[c],"enableKeyboardShortcuts"==c&&(i.checked||document.getElementById("shortcutsContainer").classList.add("disabled")),i.addEventListener("change",e)}for(var b in z){var c=z[b],i=document.getElementById(c);if("startNotebook"===c)G&&(L=a.options[c],Browser.sendToExtension({name:"getNotebooks",page:"op"}));else for(var j=a.options[c],k=0;k<i.options.length;k++)if(i.options[k].value==j){i.selectedIndex=k;break}i.addEventListener("change",f)}for(var b in A){var c=A[b],i=document.getElementById(c);i.value=a.options[c],i.addEventListener("change",g)}for(var b in B){var c=B[b];"notebookSelection"===c&&"smartFiling"===a.options[c]&&G&&G.bizAuthenticationToken&&(document.getElementById("bizSmartFilingCheckbox").style.display="block");for(var m=document.getElementsByName(c),k=0;k<m.length;k++)m.item(k).value==a.options[c]&&(m.item(k).checked=!0),m.item(k).addEventListener("change",h)}d(a),l()}}function c(a){var b=[],c=[],e=[];for(var f in a.options)a.options[f]!==D[f]&&(b.push(D[f]),c.push(a.options[f]),e.push(f));d(a),Browser.sendToExtension({name:"bounceToAll",message:{name:"updateKeyboardShortcut",oldShortcut:b,shortcut:c,shortcutName:e}})}function d(a){D={},E={},F={};for(var b in C){var c=C[b],d=document.getElementById(c);D[c]=a.options[c],E[a.options[c]]=c;var e=new ShortcutSetter(d,a.options[c],"optionsPage",function(a,b){var c=a.id;if(E[b])return E[b]==c?!1:(v=F[E[b]],v.showConflict(),{conflict:!0});if(/(\||^)27(\||$)/.test(b)&&"closeWebClipperShortcut"!==c)return{noEsc:!0};i();var d={};return d[c]=b,console.log("Sending options change:"),console.log(d),Browser.sendToExtension({name:"main_setOption",options:d}),Browser.sendToExtension({name:"bounceToAll",message:{name:"updateKeyboardShortcut",oldShortcut:D[c],shortcut:b,shortcutName:c}}),delete E[D[c]],E[b]=c,D[c]=b,!1},function(){return t?!0:(t=!0,!1)},function(){v&&(v.removeConflict(),v=null)},function(){return document.getElementById("shortcutsContainer").classList.contains("disabled")},function(a){return x[a]});F[c]=e}}function e(){var a=this.id;if(a){i();var b={};b[a]=this.checked,"enableKeyboardShortcuts"==a&&(this.checked?document.getElementById("shortcutsContainer").classList.remove("disabled"):document.getElementById("shortcutsContainer").classList.add("disabled"),Browser.sendToExtension({name:"bounceToAll",message:{name:"receiveKeyboardShortcutsEnabled",keyboardShortcutsEnabled:this.checked}})),Browser.sendToExtension({name:"main_setOption",options:b})}l()}function f(){var a=this.id;if(a){i();var b={};b[a]=this.options[this.selectedIndex].value,Browser.sendToExtension({name:"main_setOption",options:b})}l()}function g(){var a=this.id;if(a){i();var b={};b[a]=this.value,console.log("Sending options change:"),console.log(b),Browser.sendToExtension({name:"main_setOption",options:b})}l()}function h(){var a=this.name;if(a){i();var b={};b[a]=this.value,"notebookSelection"==a&&("smartFiling"===this.value&&G&&G.bizAuthenticationToken?document.getElementById("bizSmartFilingCheckbox").style.display="block":(document.getElementById("bizSmartFilingCheckbox").style.display="","alwaysStartIn"===this.value&&f.call(document.getElementById("startNotebook")))),Browser.sendToExtension({name:"main_setOption",options:b})}l()}function i(){window.setTimeout(function(){document.querySelector("#savingContainer").className="invisible"},500),document.querySelector("#savingContainer").className="visible"}function j(){event.keyCode==H[I]?I++:I=0,I==H.length&&(I=0,document.getElementById(J).style.display="none"==document.getElementById(J).style.display?"block":"none",l())}function k(b){b&&b.auth&&(G=b.auth,document.body.classList.add("loggedIn"),document.getElementById("username").innerText=G.email),a()}function l(){var a=document.getElementById("optionsContainer"),b=a.scrollHeight;document.getElementsByClassName("pinch")[0].style.height=b+"px",Browser.sendToExtension({name:"bounce",message:{name:"setOptionsHeight",height:266+b}})}function m(a,b){u&&["INPUT","TEXTAREA"].indexOf(b.nodeName)<0&&"true"!==b.contentEditable&&Browser.sendToExtension({name:"bounce",message:{name:"duplicateKeyboardShortcut",keycode:a}})}function n(a,b){["INPUT","TEXTAREA"].indexOf(b.nodeName)<0&&"true"!==b.contentEditable&&Browser.sendToExtension({name:"bounce",message:{name:"duplicateKeyboardShortcut",keycode:a}})}function o(a){"charCodeCache"==a.key&&(x=a.value||{},Browser.sendToExtension({name:"main_isAuthenticated",type:"options"}))}function p(){location.reload()}function q(a){if(u=a.enabled,a.handlers){var b={};for(var c in a.handlers)for(var d=0;d<a.handlers[c].length;d++)b[a.handlers[c][d]]="closeWebClipperShortcut"===c?n:m;Browser.addKeyboardHandlers(b)}}function r(a){document.getElementsByClassName("pinch")[0].style.height=a.totalHeight-266+"px"}function s(a){function b(a){return"OPTION"===a.nodeName?a.innerText:"OPTGROUP"===a.nodeName?a.label:void 0}for(var c=document.getElementById("startNotebook"),d=0;d<a.notebooks.length;d++){var e=document.createElement("option");e.text=a.notebooks[d].name,a.notebooks[d].owner&&(e.text+=" ("+a.notebooks[d].owner+")"),e.value=a.notebooks[d].guid,a.notebooks[d].stack?(K[a.notebooks[d].stack]||(K[a.notebooks[d].stack]=document.createElement("optgroup"),K[a.notebooks[d].stack].label=a.notebooks[d].stack,CommonSelector.binaryInsert(c,b,K[a.notebooks[d].stack])),CommonSelector.binaryInsert(K[a.notebooks[d].stack],b,e)):CommonSelector.binaryInsert(c,b,e),a.notebooks[d].defaultNotebook&&(M=e),L&&L===a.notebooks[d].guid&&(e.selected=!0,N=!0)}M&&!N&&(M.selected=!0)}var t=!1,u=!0;window.addEventListener("DOMContentLoaded",function(){document.getElementById("signOut").addEventListener("click",function(){Browser.sendToExtension({name:"LOGOUT"}),Browser.sendToExtension({name:"trackEvent",category:"Account",action:"sign_out",endSession:!0})}),document.getElementById("resetShortcuts").addEventListener("click",function(){i(),Browser.sendToExtension({name:"main_clearOptions",options:C})}),document.getElementById("done").addEventListener("click",function(){Browser.sendToExtension({name:"bounce",message:{name:"hideOptions",authed:!!G}})}),Browser.sendToExtension({name:"getPersistentValue",key:"charCodeCache"})}),Browser.addMessageHandlers({logoutCallback:p,options_config:b,options_isAuthenticated:k,optionsCleared:c,op_receivePersonalNotebooks:s,op_receiveSharedNotebooks:s,op_receiveBusinessNotebooks:s,op_setKeyboardHandlers:q,op_setPinchHeight:r,receivePersistentValue:o});var v,w,x,y=["smartFilingTags","alwaysTagWith","useSearchHelper","simulateSimplifiedChinese","useStage","enableKeyboardShortcuts","bizSmartFilingEnabled","includeDebugInfo"],z=["startNotebook","clipAction","readingSpeed","voice"],A=["alwaysTags","insecureProto","secureProto","overrideServiceURL","relatedNotesContext"],B=["notebookSelection","defaultClipAction","afterClip","simulateClippingError"],C=["startWebClipperShortcut","closeWebClipperShortcut","previewArticleShortcut","previewFullPageShortcut","previewUrlShortcut","selectionModeShortcut","takeScreenshotShortcut","clearlyShortcut","pdfShortcut","emailShortcut","expandArticleShortcut","contractArticleShortcut","moveArticleUpShortcut","moveArticleDownShortcut","selectNotebookShortcut","addTagsShortcut","saveShortcut","selectAllMarkupShortcut","arrowShortcut","textShortcut","rectangleShortcut","roundedRectangleShortcut","ellipseShortcut","lineShortcut","markerShortcut","highlighterShortcut","stampShortcut","pixelateShortcut","cropShortcut","zoomInShortcut","zoomOutShortcut","zoomToFitShortcut","zoomToOriginalShortcut","undoShortcut","redoShortcut"],D={},E={},F={},G=null;window.addEventListener("keydown",function(a){x&&(a.keyCode<65||a.keyCode>90)&&(w=a.keyCode)},!0),window.addEventListener("keypress",function(a){x&&w&&(w!=a.charCode&&(x[w]=a.charCode,Browser.sendToExtension({name:"setPersistentValue",key:"charCodeCache",value:x})),w=null)}),window.addEventListener("keydown",j);var H=[38,38,40,40,37,39,37,39,66,65],I=0,J="developerContainer",K={},L=null,M=null,N=!1;Object.preventExtensions(this)}Object.preventExtensions(OptionsController);var optionsController=new OptionsController;window.addEventListener("DOMContentLoaded",function(){function a(a){if(a.bootstrapInfo&&a.bootstrapInfo.name){a.bootstrapInfo.name.match(/china/i)&&document.body.classList.add("china");var b="https://"+a.bootstrapInfo.serviceHost;document.getElementById("copyright").innerHTML=Browser.i18n.getMessage("copyright",[(new Date).getFullYear(),b]),document.getElementById("logDescription").innerHTML=Browser.i18n.getMessage("options_eventLogDescription",[b+"/privacy"]);for(var c=document.getElementsByClassName("tab"),d=0;d<c.length;d++)c.item(d).addEventListener("click",function(){var a=document.querySelector(".tab.pressed");a&&(a.className=a.className.replace(/\s*pressed/g,""));var b=document.querySelector(".pinch");b.className=b.className.replace(/\s*(options|shortcuts|legal)/g,""),this.className+=" pressed","optionsTab"==this.id?b.className+=" options":"shortcutsTab"==this.id?b.className+=" shortcuts":"legalTab"==this.id&&(b.className+=" legal")});/shortcuts/.test(document.location.hash)&&document.getElementById("shortcutsTab").click()}}function b(a){"EVERNOTE_VERSION"==a.key&&(document.getElementById("version").innerText=a.value+" ("+BUILD_VERSION+"/"+SKITCH_BUILD_VERSION+")")}SAFARI&&document.body.classList.add("safari"),/iframe/.test(document.location.hash)&&document.body.classList.add("iframe"),Browser.addMessageHandlers({options_config:a,receivePersistentValue:b}),Browser.sendToExtension({name:"main_getConfig",bootstrapInfo:{name:null,serviceHost:null},returnName:"options_config"}),Browser.sendToExtension({name:"getPersistentValue",key:"EVERNOTE_VERSION"})}),window.addEventListener("error",function(a){log.error(JSON.stringify(a))});