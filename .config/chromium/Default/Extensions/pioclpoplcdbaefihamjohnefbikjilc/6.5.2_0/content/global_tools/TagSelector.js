/*! Copyright 2009-2015 Evernote Corporation. All rights reserved. */
function TagSelector(a,b,c){"use strict";function d(){var a=document.activeElement===B;return B.innerText="",B.blur(),a}function e(a){g(w,a)}function f(a){g(x,a)}function g(a,b){for(var c=0;c<b.length;c++)for(var d=new Tag(b[c].name),e=b[c].name.split(/\s+/),f=0;f<e.length;f++)if(d.paths.indexOf(e[f])<0&&d.paths.push(e[f]),a.insert(e[f],d),CommonSelector.SPECIAL_CHAR_REGEX.test(e[f])){var g=e[f].replace(CommonSelector.SPECIAL_CHAR_REGEX,"");d.paths.indexOf(g)<0&&d.paths.push(g),a.insert(g,d)}}function h(a){if(C.children.length<u&&""!==a&&!z[a.toLowerCase()]){var b=document.createElement("div");b.innerText=a;var c=document.createElement("div");c.classList.add("tTag"),c.title=a,b.classList.add("tTagText");var d=document.createElement("div");d.classList.add("tDeleteTag"),d.addEventListener("click",function(){k(this.parentNode)}),c.appendChild(d),c.appendChild(b),C.appendChild(c),C.children.length>=u&&l(v.EXCEEDED_MAX),o(),z[a.toLowerCase()]=1}}function i(a){h(a.trim()),B.innerHTML="",s(null,"")}function j(a){var b=document.createElement("div");b.innerText=a,b.title=a,b.classList.add("tDropdownTag"),b.addEventListener("mouseover",function(){for(var a=D.querySelectorAll(".tHover"),b=0;b<a.length;b++)a[b].classList.remove("tHover");this.classList.add("tHover")}),b.addEventListener("mousedown",function(a){1===a.which&&i(this.innerText),a.preventDefault()}),CommonSelector.binaryInsert(D,function(a){return a.innerText},b),A[a]=1}function k(a){delete z[a.lastElementChild.innerText.toLowerCase()],a.parentNode.removeChild(a),C.children.length<u&&m(),o(),c()}function l(a){B.classList.add("tDisabled"),B.contentEditable="false",a===v.EXCEEDED_MAX?B.classList.add("tMax"):a===v.LINKED_NOTEBOOK&&(B.classList.add("tLinked"),C.style.display="none"),c()}function m(){B.classList.remove("tDisabled","tMax","tLinked"),B.contentEditable="true",C.style.display="",c()}function n(){var a=[];if(!B.classList.contains("tDisabled")||!B.classList.contains("tLinked"))for(var b=0;b<C.children.length;b++)a.push(GlobalUtils.removeControlCharacters(C.children[b].lastElementChild.innerText));return a}function o(){for(var a=0,b=C.children.length-1;b>=0;b--)if(a||(a=C.children[b].offsetTop),C.children[b].offsetTop===a)C.children[b].classList.add("lastRow");else{if(!C.children[b].classList.contains("lastRow"))break;C.children[b].classList.remove("lastRow")}}function p(){B.focus()}function q(a,b){for(var c=a.join(" "),d=0;d<b.length;d++)if(!new RegExp("(\\s|^)"+b[d].replace(/([\\\^\$\.\|\?\*\+\(\)\[\{\]\}])/g,"\\$1"),"i").test(c))return!1;return!0}function r(){w=new Trie,x=new Trie,y=null}function s(a,c){if(D.innerHTML="",A={},a&&""!==c.trim())for(var d=c.split(/\s+/),e=a.getMatching(d[0],75),f=0;f<e.length;f++)for(var g=0;g<e[f][1].length;g++)z[e[f][1][g].name.toLowerCase()]||A[e[f][1][g].name]||!q(e[f][1][g].paths,d)||j(e[f][1][g].name);b()}function t(a){m(),C.children.length>=u&&l(v.EXCEEDED_MAX),a===GlobalUtils.NOTEBOOK_TYPE_PERSONAL?y=w:a===GlobalUtils.NOTEBOOK_TYPE_LINKED?l(v.LINKED_NOTEBOOK):a===GlobalUtils.NOTEBOOK_TYPE_BUSINESS&&(y=x)}var u=20,v={EXCEEDED_MAX:1,LINKED_NOTEBOOK:2},w=new Trie,x=new Trie,y=null,z={},A={};a.classList.add("tContainer");var B=document.createElement("div");B.classList.add("tInput"),B.dataset.placeholder=Browser.i18n.getMessage("quickNote_addTags"),B.dataset.maxTagsPlaceholder=Browser.i18n.getMessage("tagNamesNotInRange"),B.dataset.linkedPlaceholder=Browser.i18n.getMessage("quickNote_tagsDisabled"),B.tabIndex=3;var C=document.createElement("div");C.classList.add("tExisting");var D=document.createElement("div");D.classList.add("tDropdown"),m(),B.addEventListener("input",function(){B.innerText=B.innerText,B.innerText=B.innerText.replace(/\n/g,"");var a=B.innerText.split(/\s*,\s*/);if(a.length>1)for(var b=0;b<a.length;b++)i(a[b]);else s(y,B.innerText)}),B.addEventListener("blur",function(){i(B.innerText)}),B.addEventListener("keydown",function(a){if(13===a.keyCode){var b=D.querySelector(".tHover");i(b?b.innerText:B.innerText)}else if(["Up","Down"].indexOf(a.keyIdentifier)>=0){var b=D.querySelector(".tHover");if(b){var c=null;c="Up"===a.keyIdentifier?b.previousElementSibling:b.nextElementSibling}else c=D.firstElementChild;c&&(c.classList.add("tHover"),b&&b.classList.remove("tHover"),c.scrollIntoViewIfNeeded()),a.preventDefault()}}),D.addEventListener("mousedown",function(a){a.preventDefault()}),a.appendChild(B),a.appendChild(C),a.appendChild(D),this.abort=d,this.addBusinessTags=f,this.addPersonalTags=e,this.addTagAndClearInput=i,this.focus=p,this.getTags=n,this.reset=r,this.setActiveTrie=t,this.__defineGetter__("height",function(){return D.offsetTop+D.offsetHeight}),Object.preventExtensions(this)}function Tag(a){"use strict";this.name=a,this.paths=[],Object.preventExtensions(this)}Object.preventExtensions(TagSelector),Object.preventExtensions(Tag);