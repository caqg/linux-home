/*! Copyright 2009-2015 Evernote Corporation. All rights reserved. */
function addContact(a){recipientInput.addLozengeAndClearInput(a),a.type===ContactType.EMAIL&&Browser.sendToExtension({name:"findContactByEmail",email:a.id}),enableSendButtonIfNeeded()}function clearSection(a){if(a===suggestedChats)threadInfo={};else if(a===suggestedContacts)contactInfo={};else if(a===selectedThread){persistThreadReadStatus(),messageInfo={};for(var b in selectedThread.dataset)delete selectedThread.dataset[b];originalLastReadMessageId=null}a.innerHTML=""}function enableSendButtonIfNeeded(){sendButton.disabled=recipientInput.getLozenges().length?document.body.classList.contains("noShareNote")?newMessage.value.trim()?!1:!0:!1:!0}function formatDate(a){var b=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],c=["Jan","Feb","March","April","May","June","July","Aug","Sept","Oct","Nov","Dec"],d=Browser.i18n.getMessage("workchatDateFormat"),e=new Date(a);return e.getFullYear()===(new Date).getFullYear()&&(d=Browser.i18n.getMessage("workchatDateFormatThisYear")),d.replace(/(\W|^)EEE(\W|$)/,"$1"+Browser.i18n.getMessage(b[e.getDay()])+"$2").replace(/(\W|^)MMM(\W|$)/,"$1"+Browser.i18n.getMessage(c[e.getMonth()])+"$2").replace(/(\W|^)d(\W|$)/,"$1"+e.getDate()+"$2").replace(/(\W|^)yyyy(\W|$)/,"$1"+e.getFullYear()+"$2").replace(/(\W|^)h(\W|$)/,"$1"+((e.getHours()+11)%12+1)+"$2").replace(/(\W|^)mm(\W|$)/,"$1"+(e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes())+"$2").replace(/(\W|^)a(\W|$)/,"$1"+Browser.i18n.getMessage(e.getHours()>=12?"PM":"AM")+"$2")}function hideIfEmpty(a,b){a.children.length&&!b?a.parentNode.classList.add("hasContent"):a.parentNode.classList.remove("hasContent");for(var c=0;c<suggestions.children.length;c++){if(suggestions.children[c].classList.contains("hasContent")){suggestions.classList.add("hasContent");break}suggestions.classList.remove("hasContent")}}function highlightOnlyMatch(){if(suggestedContacts.children.length+suggestedChats.children.length===1){var a=suggestedContacts.firstElementChild||suggestedChats.firstElementChild;a.classList.add("hover")}else{for(var b=suggestedContacts.getElementsByClassName("hover"),c=suggestedChats.getElementsByClassName("hover");b.length;)b[0].classList.remove("hover");for(;c.length;)c[0].classList.remove("hover")}}function isGoogleConnected(a){a.connected?findContacts.classList.remove("google","hasContent"):(findContacts.classList.add("google","hasContent"),connectGoogle.href=a.connectUrl)}function markVisibleMessagesAsRead(){for(var a=selectedThread.getElementsByClassName("unread");a.length>0;){var b=a[0];if(b.offsetTop>=selectedThread.scrollTop+selectedThread.offsetHeight)break;b.classList.remove("unread"),clearTimeout(persistThreadReadStatusTimeout),persistThreadReadStatusTimeout=setTimeout(persistThreadReadStatus,1e4)}}function messageSyncComplete(){searchChatsAndContacts("")}function needSendConfirmation(){if(!document.body.classList.contains("noShareNote")&&notebookType==GlobalUtils.NOTEBOOK_TYPE_BUSINESS)for(var a=recipientInput.getLozenges(),b=0;b<a.length;b++)if(!a[b].sameBusiness)return!0;return!1}function openThread(a){Browser.sendToExtension({name:"getMessagesOfThread",threadId:a})}function openThreadWithSelectedContacts(a){a||(a={}),a.name="findThreadByGivenContacts",a.contacts=recipientInput.getLozenges(),Browser.sendToExtension(a)}function persistThreadReadStatus(){if(clearTimeout(persistThreadReadStatusTimeout),selectedThread.dataset.threadId){var a=selectedThread.getElementsByClassName("unread")[0];if(a){var b=a.previousElementSibling;if(!b.classList.contains("message")){var c=b.parentNode.previousElementSibling;c&&(b=c.lastElementChild)}b.classList.contains("message")&&originalLastReadMessageId!=b.dataset.id&&Browser.sendToExtension({name:"updateThreadReadStatus",messageId:b.dataset.id,threadId:selectedThread.dataset.threadId})}else{var d=selectedThread.lastElementChild;if(d){var e=d.lastElementChild;e&&originalLastReadMessageId!=e.dataset.id&&Browser.sendToExtension({name:"updateThreadReadStatus",messageId:e.dataset.id,threadId:selectedThread.dataset.threadId})}}}}function receiveContacts(a){if(a.contactSearchNum>newestContactSearchReceived){newestContactSearchReceived=a.contactSearchNum,clearSection(suggestedContacts);for(var b=0;b<a.contacts.length;b++)if(!recipientInput.hasLozenge(a.contacts[b].id)){if(suggestedContacts.children.length>=MAX_CONTACTS_TO_SHOW)break;var c=document.createElement("div");c.classList.add("contact"),c.dataset.id=a.contacts[b].id,a.contacts[b].sameBusiness?c.classList.add("sameBusiness"):a.contacts[b].google&&c.classList.add("google"),contactInfo[c.dataset.id]=a.contacts[b],contactInfo[c.dataset.id].name=contactInfo[c.dataset.id].name||contactInfo[c.dataset.id].email,c.addEventListener("click",function(){selectSearchResult(),addContact(contactInfo[this.dataset.id]),openThreadWithSelectedContacts(),recipientInput.focus()}),c.addEventListener("mouseenter",function(){this.classList.add("hover")}),c.addEventListener("mouseleave",function(){this.classList.remove("hover")});var d=document.createElement("img");a.contacts[b].photoUrl?(d.dataset.thumbnailNumber=thumbnailNumber++,Browser.sendToExtension(a.contacts[b].google?{name:"downloadThumbnail",guid:d.dataset.thumbnailNumber,method:"GET",url:a.contacts[b].photoUrl}:{name:"downloadThumbnail",guid:d.dataset.thumbnailNumber,method:"GET",size:32,url:a.contacts[b].photoUrl})):d.src=Browser.extension.getURL(devicePixelRatio>1?"images/workchat-no-photo@2x.png":"images/workchat-no-photo.png");var e=document.createElement("div");e.classList.add("container");var f=document.createElement("div");f.textContent=a.contacts[b].name||a.contacts[b].email,f.classList.add("name");var g=document.createElement("div");g.classList.add("details"),g.textContent=a.contacts[b].role||a.contacts[b].email,e.appendChild(f),e.appendChild(g),c.appendChild(d),c.appendChild(e),suggestedContacts.appendChild(c)}hideIfEmpty(suggestedContacts),highlightOnlyMatch(),a.contacts.length?Browser.sendToExtension({name:"findThreads",contacts:a.contacts,requiredContacts:recipientInput.getLozenges(),contactSearchNum:a.contactSearchNum}):receiveThreads({threads:[],contactSearchNum:a.contactSearchNum})}}function receiveMessagesOfThread(a){var b=null,c=null,d=0;if(a.update){if(a.updateViewNum&&a.updateViewNum<updateViewNum)return;if(b=selectedThread.lastElementChild){var e=messageInfo[b.lastElementChild.dataset.id];c=e.sender.id,d=e.time}for(var f=selectedThread.getElementsByClassName("unread");f.length&&f[0].dataset.id<=a.lastReadMessageId;)f[0].classList.remove("unread")}else clearSection(selectedThread);selectedThread.dataset.threadId=a.threadId,originalLastReadMessageId=a.lastReadMessageId;for(var g=0;g<a.messages.length;g++){if(a.messages[g].sender.id!=c||a.messages[g].time>=d+12e5){b=document.createElement("div"),b.classList.add("messageTurn");var h=document.createElement("div");if(h.classList.add("sender"),!a.messages[g].sender.self){var i=document.createElement("img");i.classList.add("photo"),a.messages[g].sender.photoUrl?(i.dataset.thumbnailNumber=thumbnailNumber++,Browser.sendToExtension({name:"downloadThumbnail",guid:i.dataset.thumbnailNumber,method:"GET",size:32,url:a.messages[g].sender.photoUrl})):i.src=Browser.extension.getURL(devicePixelRatio>1?"images/workchat-no-photo@2x.png":"images/workchat-no-photo.png"),h.appendChild(i);var j=document.createElement("div");j.classList.add("name"),j.textContent=a.messages[g].sender.name,h.appendChild(j)}var k=document.createElement("div");k.classList.add("messageTime"),k.textContent=formatDate(a.messages[g].time),h.appendChild(k),a.messages[g].sender.self&&b.classList.add("self"),b.appendChild(h),selectedThread.appendChild(b),c=a.messages[g].sender.id}messageInfo[a.messages[g].id]=a.messages[g];var l=document.createElement("div");l.classList.add("message"),l.dataset.id=a.messages[g].id,a.messages[g].id>a.lastReadMessageId&&l.classList.add("unread");var m=document.createElement("div");if(m.classList.add("inner"),a.messages[g].body){var n=document.createElement("div");n.classList.add("body"),n.innerHTML=a.messages[g].body,m.appendChild(n)}if(a.messages[g].attachments)for(var o=0;o<a.messages[g].attachments.length;o++){var p=document.createElement("a");p.target="_blank",a.messages[g].attachments[o].type===MessageAttachmentType.NOTE?p.href=Browser.extension.getURL("js/main/generateUrlWithTempToken.html?baseUrl="+encodeURIComponent(a.baseUrl)+"&targetUrl="+encodeURIComponent("/MessageAttachmentDispatch.action?type=NOTE&guid="+a.messages[g].attachments[o].guid+"&userId="+a.messages[g].attachments[o].userId+"&shardId="+a.messages[g].attachments[o].shardId)):a.messages[g].attachments[o].type===MessageAttachmentType.NOTEBOOK&&(p.href=Browser.extension.getURL("js/main/generateUrlWithTempToken.html?baseUrl="+encodeURIComponent(a.baseUrl)+"&targetUrl="+encodeURIComponent("/MessageAttachmentDispatch.action?type=NOTEBOOK&title="+encodeURIComponent(a.messages[g].attachments[o].title)+"&guid="+a.messages[g].attachments[o].guid+"&userId="+a.messages[g].attachments[o].userId+"&shardId="+a.messages[g].attachments[o].shardId))),p.classList.add("attachment"),p.textContent=a.messages[g].attachments[o].title,a.messages[g].attachments[o].type===MessageAttachmentType.NOTE?p.classList.add("note"):a.messages[g].attachments[o].type===MessageAttachmentType.NOTEBOOK&&p.classList.add("notebook"),m.appendChild(p)}d=a.messages[g].time,l.appendChild(m),b.appendChild(l)}var q=selectedThread.getElementsByClassName("unread")[0];selectedThread.scrollTop=q?q.previousElementSibling.classList.contains("sender")?q.parentNode.offsetTop:q.offsetTop:selectedThread.scrollHeight-(selectedThread.offsetHeight-1),markVisibleMessagesAsRead()}function receiveThreads(a){if(a.contactSearchNum===newestContactSearchReceived){clearSection(suggestedChats);for(var b=0;b<a.threads.length;b++){var c=document.createElement("div");if(c.classList.add("existingThread"),c.dataset.threadId=a.threads[b].id,c.addEventListener("mouseenter",function(){this.classList.add("hover")}),c.addEventListener("mouseleave",function(){this.classList.remove("hover")}),c.addEventListener("click",function(){selectSearchResult();for(var a=this.dataset.threadId,b=threadInfo[a].participants,c=recipientInput.getLozenges(),d=0;d<b.length;d++){for(var e=!1,f=0;f<c.length;f++)if(c[f].type===b[d].type&&c[f].id==b[d].id){e=!0;break}e||addContact(b[d])}openThread(a),recipientInput.focus()}),a.threads[b].photos.length>1){var d=document.createElement("div");d.classList.add("thumbnailContainer");for(var e=0;2>e;e++){var f=document.createElement("img");a.threads[b].photos[e]?(f.dataset.thumbnailNumber=thumbnailNumber++,Browser.sendToExtension({name:"downloadThumbnail",guid:f.dataset.thumbnailNumber,method:"GET",size:32,url:a.threads[b].photos[e]})):f.src=Browser.extension.getURL(devicePixelRatio>1?"images/workchat-no-photo@2x.png":"images/workchat-no-photo.png"),d.appendChild(f)}c.appendChild(d)}else{var f=document.createElement("img");f.classList.add("thumbnail"),a.threads[b].photos[0]?(f.dataset.thumbnailNumber=thumbnailNumber++,Browser.sendToExtension({name:"downloadThumbnail",guid:f.dataset.thumbnailNumber,method:"GET",size:32,url:a.threads[b].photos[0]})):f.src=Browser.extension.getURL(devicePixelRatio>1?"images/workchat-no-photo@2x.png":"images/workchat-no-photo.png"),c.appendChild(f)}var g=document.createElement("div");g.classList.add("container");var h=document.createElement("div");h.classList.add("participants");var i=[];threadInfo[c.dataset.threadId]={participants:[]};for(var e=0;e<a.threads[b].participants.length;e++)i.push(a.threads[b].participants[e].name?a.threads[b].participants[e].name:a.threads[b].participants[e].id),threadInfo[c.dataset.threadId].participants.push(a.threads[b].participants[e]);h.textContent=i.join(", ");var j=document.createElement("div");j.classList.add("snippet"),j.innerHTML=a.threads[b].snippet||"&nbsp;",g.appendChild(h),g.appendChild(j),c.appendChild(g),suggestedChats.appendChild(c)}hideIfEmpty(suggestedChats),highlightOnlyMatch()}}function receiveThreadByGivenContacts(a){a.updateViewNum&&a.updateViewNum<updateViewNum||(a.thread?openThread(a.thread.id,a.thread.participants):clearSection(selectedThread))}function receiveThumbnail(a){var b=document.querySelector("img[data-thumbnail-number='"+a.guid+"']");b&&(b.src=a.datauri)}function searchChatsAndContacts(a){a=a.trim(),contactSearchNum=Math.max(contactSearchNum,newestContactSearchReceived)+1,a?Browser.sendToExtension({name:"findWorkchatContacts",query:a,contactSearchNum:contactSearchNum}):(receiveContacts({contacts:[],contactSearchNum:contactSearchNum}),Browser.sendToExtension({name:"getThreads",contactSearchNum:contactSearchNum})),findContacts.classList.add("hasContent")}function selectSearchResult(){newestContactSearchReceived=contactSearchNum+1}function sendChat(){if(!needSendConfirmation()||window.confirm(Browser.i18n.getMessage("bizWorkchatWarning"))){var a={name:"sendChat",body:newMessage.value,threadRecipient:selectedThread.dataset.threadId,contactRecipients:recipientInput.getLozenges(),noteShardId:noteShardId,noteToken:noteToken,noteSharePrivilege:noteShareSelect.getSelected().id};document.body.classList.contains("noShareNote")||(a.attachments=[{guid:noteGuid,shardId:noteShardId,title:noteTitle,userId:noteUserId}],Browser.sendToExtension({name:"trackEvent",category:"Share",action:"workchat_completed",label:a.body?"added_text":"no_text"})),Browser.sendToExtension(a),newMessage.value="",document.body.classList.add("noShareNote"),enableSendButtonIfNeeded(),Browser.sendToExtension({name:"trackEvent",category:"Workchat",action:"sent_message",value:a.contactRecipients.length})}}function updateEmailContactWithUserId(a){recipientInput.updateExistingLozenge(a.email,{id:a.user.id,name:a.user.name,type:ContactType.EVERNOTE})}function updateView(){if(selectedThread.dataset.threadId){var a=selectedThread.lastElementChild?selectedThread.lastElementChild.lastElementChild.dataset.id:0;Browser.sendToExtension({name:"getMessagesOfThread",afterMessageId:a,threadId:selectedThread.dataset.threadId,updateViewNum:++updateViewNum})}else recipientInput.getLozenges().length&&openThreadWithSelectedContacts({updateViewNum:++updateViewNum});suggestions.classList.contains("hasContent")&&searchChatsAndContacts(recipientInput.input.value)}var recipients,recipientInput,suggestions,suggestedChats,threadInfo,suggestedContacts,contactInfo,findContacts,connectGoogle,selectedThread,messageInfo,originalLastReadMessageId,noteShare,noteShareSelect,newMessage,sendButton,noteGuid,noteTitle,noteShardId,noteUserId,noteToken,notebookType,thumbnailNumber=1,updateViewNum=0,contactSearchNum=0,newestContactSearchReceived=0,MAX_CONTACTS_TO_SHOW=3,persistThreadReadStatusTimeout;window.addEventListener("beforeunload",function(){Browser.sendToExtension({name:"closeWebSocket"})}),window.addEventListener("DOMContentLoaded",function(){for(var a=/([^=?&]+)=([^&]+)/g,b=a.exec(location.search);b;)"guid"===b[1]?noteGuid=b[2]:"title"===b[1]?noteTitle=decodeURIComponent(b[2]):"shardId"===b[1]?noteShardId=b[2]:"userId"===b[1]?noteUserId=b[2]:"token"===b[1]?noteToken=b[2]:"notebookType"===b[1]&&(notebookType=b[2]),b=a.exec(location.search);recipients=document.getElementById("recipients").lastElementChild,suggestions=document.getElementById("suggestions"),suggestedChats=document.querySelector("#suggestedChats .content"),suggestedContacts=document.querySelector("#suggestedContacts .content"),findContacts=document.getElementById("findContacts"),connectGoogle=document.getElementById("google"),selectedThread=document.getElementById("selectedThread"),noteShare=document.getElementById("noteShare"),newMessage=document.getElementById("newMessage"),sendButton=document.getElementById("sendButton"),recipientInput=new LozengeInput(recipients,Browser.i18n.getMessage("enterNameOrEmail"),searchChatsAndContacts,function(){clearSection(suggestedChats),clearSection(suggestedContacts),hideIfEmpty(suggestedChats),hideIfEmpty(suggestedContacts),hideIfEmpty(findContacts.lastElementChild,!0)},function(){openThreadWithSelectedContacts(),enableSendButtonIfNeeded()},function(a){var b=suggestedContacts.getElementsByClassName("hover")[0];if(b)return b.click(),!1;var c=suggestedChats.getElementsByClassName("hover")[0];return c?(c.click(),!1):/^[A-Za-z0-9!#$%&'*+\/=?^_`{|}~-]+(\.[A-Za-z0-9!#$%&'*+\/=?^_`{|}~-]+)*@[A-Za-z0-9-]+(\.[A-Za-z0-9-]+)*\.([A-Za-z]{2,})$/.test(a)?(selectSearchResult(),addContact({id:a,type:ContactType.EMAIL}),openThreadWithSelectedContacts(),!1):!1},function(){var a=suggestedChats.getElementsByClassName("hover")[0]||suggestedContacts.getElementsByClassName("hover")[0];if(a)if(a.classList.remove("hover"),a.previousElementSibling)a.previousElementSibling.classList.add("hover");else{var b=a.parentNode,c=null;c=b===suggestedChats?suggestedContacts:suggestedChats,c.lastElementChild?c.lastElementChild.classList.add("hover"):b.lastElementChild.classList.add("hover")}else{var d=suggestedContacts.lastElementChild||suggestedChats.lastElementChild;d&&d.classList.add("hover")}},function(){var a=suggestedChats.getElementsByClassName("hover")[0]||suggestedContacts.getElementsByClassName("hover")[0];if(a)if(a.classList.remove("hover"),a.nextElementSibling)a.nextElementSibling.classList.add("hover");else{var b=a.parentNode,c=null;c=b===suggestedChats?suggestedContacts:suggestedChats,c.firstElementChild?c.firstElementChild.classList.add("hover"):b.firstElementChild.classList.add("hover")}else{var d=suggestedChats.firstElementChild||suggestedContacts.firstElementChild;d&&d.classList.add("hover")}}),selectedThread.addEventListener("scroll",markVisibleMessagesAsRead),noteShareSelect=new SelectWithLabel(noteShare),noteShareSelect.setLabelName(noteTitle),noteShareSelect.addSelectOption({id:SharedNotePrivilegeLevel.FULL_ACCESS,name:Browser.i18n.getMessage("canEditInvite")}),noteShareSelect.addSelectOption({id:SharedNotePrivilegeLevel.MODIFY_NOTE,name:Browser.i18n.getMessage("canEdit")}),noteShareSelect.addSelectOption({id:SharedNotePrivilegeLevel.READ_NOTE,name:Browser.i18n.getMessage("canView")}),noteShareSelect.setSelected(0),newMessage.placeholder=Browser.i18n.getMessage("typeYourMessage"),newMessage.addEventListener("focus",function(){recipientInput.blurExistingLozenges()}),newMessage.addEventListener("keydown",function(a){13===a.keyCode&&(a.shiftKey||(a.preventDefault(),sendButton.click()))}),newMessage.addEventListener("input",function(){enableSendButtonIfNeeded()}),sendButton.addEventListener("click",sendChat),enableSendButtonIfNeeded(),window.addEventListener("beforeunload",persistThreadReadStatus),GlobalUtils.localize(document.documentElement),Browser.sendToExtension({name:"openWebSocket"}),Browser.sendToExtension({name:"syncMessages",responseName:"messageSyncComplete"}),Browser.sendToExtension({name:"isGoogleConnected"})}),Browser.addMessageHandlers({isGoogleConnected:isGoogleConnected,messageSyncComplete:messageSyncComplete,receiveContacts:receiveContacts,receiveMessagesOfThread:receiveMessagesOfThread,receiveThreads:receiveThreads,receiveThreadByGivenContacts:receiveThreadByGivenContacts,receiveThumbnail:receiveThumbnail,updateEmailContactWithUserId:updateEmailContactWithUserId,updateView:updateView});