/*! Copyright 2009-2015 Evernote Corporation. All rights reserved. */
function GmailClipper(){"use strict";function a(a){return a.substr(a.search(/\d/)).split(/\d+\n/)}function b(a){return a.replace(/(,{2,})/g,function(a){return a.split("").join("null")}).replace(/(\[,|,\])/g,function(a){return a.replace("[","[null").replace("]","null]")})}function c(a){f=a;var b=document.createElement("script");b.id="evernoteGmailScript",b.innerText='for (var i = 0; i < window.GLOBALS[17].length; i++) {if (window.GLOBALS[17][i] && window.GLOBALS[17][i][0] === "mla") {for (var j = 0; j < window.GLOBALS[17][i][1].length; j++) {if (window.GLOBALS[17][i][1][j][0] === window.GLOBALS[10]) {window.postMessage({name: "receiveGmailIk",baseUrl: window.GLOBALS[31],ik: window.GLOBALS[9],user: { email: window.GLOBALS[10], name: window.GLOBALS[17][i][1][j][4] }}, "*");break;}}}}document.body.removeChild(document.getElementById("evernoteGmailScript"));',document.body.appendChild(b)}function d(c,e,g,h,i,j){var k=new XMLHttpRequest;k.open("POST",c),k.baseUrl=c,k.ik=e,k.threadId=g,k.numRetryMsgs=h.length,k.thread=i,k.threadingEnabled=j,k.onreadystatechange=function(){if(4==this.readyState)if(200==this.status){for(var c=a(this.response),e=[],g=0;g<c.length;g++)if(!(""==c[g].trim()||c[g].indexOf('"ms"')<0)){var h=b(c[g]);try{for(var i=JSON.parse(h),j=0;j<i.length;j++){var k=i[j];if("ms"==k[0]&&k[3]>=2&&k[3]<=4){var l=k[1],m=new GmailMessage(this.baseUrl);k[13]?(m.setAuthorInfo(k[5],k[6]),this.thread.setSubject(k[13][21]),m.setBody(k[13][6]),this.thread.addParticipants([[k[5],k[6]]]),this.thread.addParticipants(k[13][9][1]),this.thread.addParticipants(k[13][9][0]),m.addAttachments(k[13][7][0]),m.setDate(k[24])):e.push(l),this.thread.addMessage(m,l)}}}catch(n){return log.error("\n"+n.stack),log.log(h),void f(null,"could not parse. check console for more details")}}e.length>0&&0===this.numRetryMsgs?d(this.baseUrl,this.ik,this.threadId,e,this.thread,this.threadingEnabled):e.length>0?(this.thread.removeMessages(e),f(this.thread)):f(this.thread)}else log.error("could not download gmail thread "+this.threadId+" with ik="+this.ik+" because of ("+this.status+") "+this.response),f(null,"could not download gmail thread "+this.threadId+" with ik="+this.ik+" because of ("+this.status+") "+this.response)},k.setRequestHeader("Content-type","application/x-www-form-urlencoded");var l="ik="+k.ik+"&ui=2&view=cv&ser=1&th="+k.threadId+"&pcd=1&mb="+(k.threadingEnabled?"0":"1")+"&rt=c";l+=h.length>0?"&msgs="+h.join(",")+"&search=inbox":"&search=query",k.send(l)}function e(c,d,e){var g=new XMLHttpRequest;g.open("POST",c),g.baseUrl=c,g.ik=d,g.onreadystatechange=function(){if(4==this.readyState)if(200==this.status)try{var c=a(this.response),d=!0;a:for(var g=0;g<c.length;g++)if(!(""==c[g].trim()||c[g].indexOf('"p"')<0))for(var h=JSON.parse(b(c[g])),i=0;i<h.length;i++)if("p"==h[i][0])for(var j=0;j<h[i][1].length;j++)if("bx_vmb"==h[i][1][j][0]){d=0==h[i][1][j][1];break a}e(this.baseUrl,this.ik,d)}catch(k){log.error("could not parse the settings response.\n"+k.stack),log.log(this.response),f(null,"could not parse settings. check internal clipper logs for more details")}else log.error("could not download settings from baseUrl="+this.baseUrl+", ik="+this.ik+" with status ("+this.status+") "+this.response),e(this.baseUrl,this.ik,!0)},g.setRequestHeader("Content-type","application/x-www-form-urlencoded"),g.send("ik="+d+"&view=pu&rt=c")}var f;window.addEventListener("message",function(a){"receiveGmailIk"==a.data.name&&(/mail\/$/.test(a.data.baseUrl)&&(a.data.baseUrl+="u/0/"),e(a.data.baseUrl,a.data.ik,function(b,c,e){var g=null;if(/#.+?.*\/(.+?)($|\?)/.test(window.location.href))g=/#.+?.*\/(.+?)($|\?)/.exec(window.location.href)[1];else for(var h=document.querySelectorAll("[class^=m], [class*=' m']"),i=0;i<h.length;i++)if(/(\s|^)m([^\s]{5,})/.test(h[i].className)){g=/(\s|^)m([^\s]{5,})/.exec(h[i].className)[2];break}if(!g)return log.error("could not find thread Id for email: "+window.location.href),void f(null,"could not find thread id. check clipper logs for more details");var j=new GmailThread;j.setUser(a.data.user.name,a.data.user.email),d(b,c,g,[],j,e)}))}),this.getThread=c,Object.preventExtensions(this)}Object.preventExtensions(GmailClipper);