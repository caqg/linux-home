function Extension(){var E,A;function F(a){if(!a)log.warn("Version out of date!");else if(!P){P=!0;Persistent.get("localStoragePurged")||(Persistent.set("localStoragePurged",!0),delete localStorage.savedAuthInfo,delete localStorage.userCache);m=new BootstrapInfo(options.get("overrideServiceURL"));auth=new Auth(options.get("overrideServiceURL"),options.get("secureProto"));!t&&auth&&(t=new UsageMetricsManager(options.get("secureProto")+m.get("serviceHost"),auth.isAuthenticated,options.get("secureProto"),
m.get("serviceHost"),options.get("overrideServiceURL"),auth.updateUserStatus));Q();5>=versionDetect.getLastVersionParsed()[0]&&6===versionDetect.getSourceVersionParsed()[0]&&auth.logoutAll();if(6!==versionDetect.getSourceVersionParsed()[0])throw Error("check if need to update version");firstTime.startUp();G();la();firstTime.msgHandlerOnInit(function(){G()});B({startup:!0});auth.getCurrentUser()&&s({category:"Install or Update",action:"set_user_cd",data:R()});ma()}}function Q(){SAFARI||H||(H=!0,chrome.contextMenus.removeAll(function(){na()}))}
function v(){alert(Browser.i18n.getMessage("contextMenuPleaseLogin"))}function oa(a){var c=safari.application.activeBrowserWindow.activeTab,b=a.userInfo;switch(a.command){case p.clipPage:S(c);break;case p.clipScreenshot:T(c);break;case p.clipSelection:U(b,c);break;case p.clipImage:V(b,c);break;case p.clipPDF:W(c);break;case p.clipUrl:X(c)}}function pa(a){var c=a.userInfo;if(!c||!c.url||c.url.match(/^https?/i)&&!c.url.match(/^https?:\/\/extensions.apple.com/i))a.contextMenu.appendContextMenuItem(p.clipPage,
Browser.i18n.getMessage("safariContextClipPage"),p.clipPage),a.contextMenu.appendContextMenuItem(p.clipScreenshot,Browser.i18n.getMessage("safariContextClipScreenshot"),p.clipScreenshot),a.userInfo&&a.userInfo.selection&&a.contextMenu.appendContextMenuItem(p.clipSelection,Browser.i18n.getMessage("safariContextClipSelection"),p.clipSelection),a.userInfo&&a.userInfo.node&&"img"==a.userInfo.node.toLowerCase()&&a.contextMenu.appendContextMenuItem(p.clipImage,Browser.i18n.getMessage("safariContextClipImage"),
p.clipImage),a.userInfo&&a.userInfo.pdf&&a.contextMenu.appendContextMenuItem(p.clipPDF,Browser.i18n.getMessage("safariContextClipPDF"),p.clipPDF),a.contextMenu.appendContextMenuItem(p.clipUrl,Browser.i18n.getMessage("safariContextClipUrl"),p.clipUrl)}function qa(a){return a.bizAuthenticationToken?"Business":a.premium?"Premium":"Free"}function S(a){t.recordActivity(auth.isAuthenticated);u(a.url)||auth.isAuthenticated(function(c){c?Browser.sendToTab(a,{name:"startSubmission",clipType:"fullPage",contextMenu:!0,
smartFilingNotebookAvailable:!1}):v()})}function T(a){t.recordActivity(auth.isAuthenticated);u(a.url)||auth.isAuthenticated(function(c){c?Y({contextMenu:!0},{tab:a},function(c){Browser.sendToTab(a,{name:"startSubmission",clipType:"screenshot",contextMenu:!0,screenshotUrl:c,smartFilingNotebookAvailable:!1})}):v()})}function U(a,c){t.recordActivity(auth.isAuthenticated);u(c.url)||auth.isAuthenticated(function(b){b?Browser.sendToTab(c,{name:"startSubmission",clipType:"selection",contextMenu:!0,selectionText:a.selectionText,
smartFilingNotebookAvailable:!1}):v()})}function V(a,c){t.recordActivity(auth.isAuthenticated);u(c.url)||auth.isAuthenticated(function(b){b?Browser.sendToTab(c,{name:"startSubmission",clipType:"image",contextMenu:!0,imageUrl:a.srcUrl,smartFilingNotebookAvailable:!1}):v()})}function W(a){t.recordActivity(auth.isAuthenticated);u(a.url)||auth.isAuthenticated(function(c){c?Browser.sendToTab(a,{name:"startSubmission",clipType:"pdf",contextMenu:!0,smartFilingNotebookAvailable:!1}):v()})}function X(a){t.recordActivity(auth.isAuthenticated);
u(a.url)||auth.isAuthenticated(function(c){c?Browser.sendToTab(a,{name:"startSubmission",clipType:"url",contextMenu:!0,smartFilingNotebookAvailable:!1}):v()})}function na(){H=!1;var a=["http://*/*","https://*/*"],c=["http://*/*","https://*/*","chrome-extension://encfpfilknmenlmjemepncnlbbjlabkc/*","chrome-extension://oemmndcbldboiebfnladdacbdfmadadm/*"];chrome.contextMenus.create({id:"fullPage",title:Browser.i18n.getMessage("contextMenuClipPage"),contexts:["page","image","selection"],documentUrlPatterns:a});
chrome.contextMenus.create({id:"screenshot",title:Browser.i18n.getMessage("contextMenuClipScreenshot"),contexts:["page","image","selection"],documentUrlPatterns:a});chrome.contextMenus.create({id:"selection",title:Browser.i18n.getMessage("contextMenuClipSelection"),contexts:["selection"],documentUrlPatterns:c});chrome.contextMenus.create({id:"image",title:Browser.i18n.getMessage("contextMenuClipImage"),contexts:["image"],targetUrlPatterns:a});chrome.contextMenus.create({id:"pdf",title:Browser.i18n.getMessage("contextMenuClipPDF"),
contexts:["all"],documentUrlPatterns:c});chrome.contextMenus.create({id:"url",title:Browser.i18n.getMessage("contextMenuClipUrl"),contexts:["all"],documentUrlPatterns:c});chrome.contextMenus.onClicked.addListener(function(a,c){switch(a.menuItemId){case "fullPage":S(c);break;case "screenshot":T(c);break;case "selection":U(a,c);break;case "image":V(a,c);break;case "pdf":W(c);break;case "url":X(c)}})}function G(){if(SAFARI){var a=function(a,b){if(a&&"clipper"==a.identifier){b&&!/login\.html/.test(a.contentWindow.location.href)&&
(a.contentWindow.location.href=I);var d=a.contentWindow.location.href;/login\.html/.test(d)?(1<Z()?a.height=365:a.height=336,a.width=313):/registration\.html/.test(d)?(a.width=589,a.height=440):/two_factor\.html/.test(d)?(a.width=313,a.height=325):/sso\.html/.test(d)&&(a.width=298,a.height=350)}};safari.application.removeEventListener("validate",function(c){a(c.target.popover)});safari.application.addEventListener("validate",function(c){a(c.target.popover)});safari.application.removeEventListener("popover",
function(c){a(c.target,!0)});safari.application.addEventListener("popover",function(c){a(c.target,!0)})}firstTime.needToShowIntro()?(Browser.setPopup(""),Browser.setBrowserActionClickHandler(function(a){firstTime.msgHandlerOnAction(function(){G();B()})})):auth.isAuthenticated(function(a){a?(Browser.setPopup(""),Browser.setBrowserActionClickHandler(function(a){auth.isAuthenticated(function(c){c?$(a)?(c=y("marketingUrl")+"/webclipper/guide",Browser.closeTab(a),C=D=null,aa(c,function(a){ra(a,function(a){z(null,
{tab:a})})})):z(null,{tab:a}):log.warn("logged out while toggling coordinator")})})):(Browser.removeBrowserActionClickHandler(),Browser.setPopup(I))})}function ra(a,c){E=a.id;A=c}function la(){function a(a){SAFARI?(B(),a.target.browserWindow?Browser.sendToTab(a.target,{name:"isExtensionOpen"}):a.target.activeTab&&Browser.sendToTab(a.target.activeTab,{name:"isExtensionOpen"})):(B(),Browser.sendToTab({id:a.tabId},{name:"isExtensionOpen"}))}SAFARI?safari.application.addEventListener("activate",a,!0):
(chrome.tabs.onActivated.addListener(a),chrome.windows.onFocusChanged.addListener(function(c){chrome.tabs.query({active:!0,windowId:c},function(c){c&&0<c.length?a({tabId:c[0].id}):log.warn("chrome tabs query did not return a result while changing window focus")})}))}function $(a){return"undefined"===typeof D||"undefined"===typeof C?!1:a.id===D&&a.url===C}function z(a,c,b){auth.isAuthenticated(function(a){a?(Browser.sendToTab(c.tab,{name:"insertSerializationScripts"}),Browser.sendToTab(c.tab,{name:"setFavIconUrl",
favIconUrl:c.tab.favIconUrl?c.tab.favIconUrl:"http://www.google.com/s2/favicons?domain="+encodeURIComponent(c.tab.url)}),Browser.sendToTab(c.tab,{name:"toggleCoordinator",bizUser:!!a.businessId,bizComplete:!!a.bizAuthenticationToken},function(){chrome&&chrome.runtime&&chrome.runtime.lastError&&alert(Browser.i18n.getMessage("popup_couldntStart"))})):log.error("logged out while toggling clipper.")})}function s(a,c,b){auth.getCurrentUser()&&(a.data||(a.data=[]),a.data.push({slot:Analytics.CD.USER_TYPE,
value:qa(auth.getUserInfo())}));Analytics.trackEvent(a.category,a.action,a.label,a.value,a.startSession,a.endSession,a.data)}function R(){var a=[{slot:Analytics.CD.SERVICE_HOST,value:y("serviceHost")},{slot:Analytics.CD.DEVICE_ID,value:Persistent.get("deviceID")}];/china/i.test(y("name"))?a.push({slot:Analytics.CD.GLOBAL_USER_ID,value:"YX"+auth.getCurrentUser()}):a.push({slot:Analytics.CD.GLOBAL_USER_ID,value:"EN"+auth.getCurrentUser()});auth.getUserInfo().businessId&&a.push({slot:Analytics.CD.BUSINESS_VAULT_ID,
value:auth.getUserInfo().businessId});return a}function J(){Browser.setTitle(Browser.i18n.getMessage("webClipperUpdated"));Browser.setIcon("images/wc6-update")}function K(){firstTime.isUpgraded()?J():(Browser.setTitle(Browser.i18n.getMessage("BrowserActionTitle")),Browser.setIcon("images/web-clipper"))}function ba(){firstTime.isUpgraded()?J():(Browser.setTitle(Browser.i18n.getMessage("signInPrompt")),Browser.setIcon("images/web-clipper-sign-in"))}function B(a,c,b){firstTime.isUpgraded()?J():auth.getUserInfo().authenticationToken?
a&&a.startup||K():ba()}function u(a){a=(a+"").toLowerCase();a=a.match(/^https?:\/\/chrome.google.com\/(extensions|webstore)/)?!0:!1;return a?(alert(Browser.i18n.getMessage("illegalUrlClipFailure")),!0):!1}function ca(a,c,b){log.log("Got restart message...");Browser.removeMessageHandlers();window.location.reload()}function da(a,c,b){function d(b){if("simSearch"==a.type)Browser.sendToTab(c.tab,{name:"simSearch_isAuthenticated",auth:b});else if("clipResult"==a.type)Browser.sendToTab(c.tab,{name:"clipResult_isAuthenticated",
auth:b});else if("options"==a.type)Browser.sendToTab(c.tab,{name:"options_isAuthenticated",auth:b});else if("pdfTooltip"==a.type){var d=Persistent.get(b.userId+"_pdfTooltipShown");Persistent.set(b.userId+"_pdfTooltipShown",!0);b={name:"pdfTooltip_isAuthenticated",auth:b,pdfTooltipShown:d};if(a.bootstrapInfo){b.bootstrapInfo={};for(var e in a.bootstrapInfo)b.bootstrapInfo[e]=m.get(e)}Browser.sendToTab(c.tab,b)}else if("tooltip"==a.type){b={name:"tooltip_isAuthenticated",auth:b};if(a.bootstrapInfo)for(e in b.bootstrapInfo=
{},a.bootstrapInfo)b.bootstrapInfo[e]=m.get(e);Browser.sendToTab(c.tab,b)}}c&&c.tab?auth.isAuthenticated(d):auth.isAuthenticated(b)}function ma(){var a=Persistent.get("lastActiveTimes");a||(a={});var c=auth.getCurrentUser(),c=c?c:"unauthed";a[c]||(a[c]={time:(new Date).getTime(),count:0});a.unauthed||(a.unauthed={time:(new Date).getTime(),count:0});Persistent.set("lastActiveTimes",a)}function L(a,c,b){auth.logoutAll(a.authExpired);Browser.sendToTab(c.tab,{name:"logoutCallback"});Browser.removeBrowserActionClickHandler();
Browser.setPopup(I)}function ea(a){return options.get(a)}function y(a){return m?m.get(a):""}function Z(){return m?m.getLength():0}function fa(a,c,b){aa(a.url);b&&b()}function aa(a,c){if(SAFARI){var b=safari.application.activeBrowserWindow.openTab();b.url=a;c&&c(b)}else chrome.tabs.create({url:a,selected:!0},c)}function M(a,c,b){var d=c=600,f="";a.width&&(c=a.width);a.height&&(d=a.height);a.url&&(f=a.url);f&&(SAFARI?(safari.application.openBrowserWindow().activeTab.url=f,b&&b()):chrome.windows.create({url:f,
width:c,height:d,type:a.type},function(a){b&&b()}))}function ga(a,c,b){try{t.recordActivity()}catch(d){log.error("Failed to record user activity: "+d.trace||d.stack||JSON.stringify(d))}b&&b()}function ha(a,c,b){function d(a,c){var b=Persistent.get("shownNearQuotaUpsell");if(!b||!b[a]){var b=auth.getUserInfo(a).quota,d=Persistent.get("uploaded");if(d&&0.75<=((d[a]||0)+c)/b)return!0}return!1}function f(a,c){var b=Persistent.get(a+"_skitchPromoShownCount"),d=Persistent.get(a+"_skitchClipsCount");d||
(d=0);return c&&(!b||0<b&&10>b)&&0==(d-1)%3}function l(c,b,d){(new Submitter({submit:c,authenticationToken:d.authenticationToken,bizAuthenticationToken:d.bizAuthenticationToken,shared:b},d.premium,k,d.userId,function(a){e(a,d)})).createNoteWithThrift(a.title,a.notebook.guid,a.notebook.name,a.notebook.noShareNotes,a.tags,a.comment,a.url,a.clipType,a.content,a.resources)}function e(b,e){if("fail"===b.name)b.name="handleFailure",Persistent.get(e.userId+"_sawRatingsPrompt")||Persistent.clear(e.userId+
"_successfulClipsCount"),5>Persistent.get(e.userId+"_sawReferralCount")&&Persistent.clear(e.userId+"_clipsCount_referral"),Browser.sendToTab(c.tab,b),delete r[a.pendingNoteKey];else if("success"===b.name){b.name="handleSuccess";if(!Persistent.get(e.userId+"_sawRatingsPrompt")){var g=Persistent.get(e.userId+"_successfulClipsCount");g||(g=0);Persistent.set(e.userId+"_successfulClipsCount",++g)}5>Persistent.get(e.userId+"_sawReferralCount")&&((g=Persistent.get(e.userId+"_clipsCount_referral"))||(g=0),
Persistent.set(e.userId+"_clipsCount_referral",++g));b.skitchNote&&((g=Persistent.get(e.userId+"_skitchClipsCount"))||(g=0),Persistent.set(e.userId+"_skitchClipsCount",++g));if(!Persistent.get(e.userId+"_sawRatingsPrompt")&&10<=Persistent.get(e.userId+"_successfulClipsCount"))b.showRatings=!0;else if(d(e.userId,b.noteSize))b.nearQuota=!0;else if(5>Persistent.get(e.userId+"_sawReferralCount")&&20<=Persistent.get(e.userId+"_clipsCount_referral"))b.showReferral=!0;else if(f(e.userId,b.skitchNote)){sa(e.shardId).getCrossPromotionInfo(e.authenticationToken,
function(d){(d.usesSkitchAndroid||d.usesSkitchIOS||d.usesSkitchMac||d.usesSkitchWindows)&&Persistent.set(e.userId+"_skitchPromoShownCount",10);f(e.userId,!0)&&(b.skitch=!0);delete b.noteSize;Browser.sendToTab(c.tab,b);delete r[a.pendingNoteKey]},function(d){log.error(JSON.stringify(d));delete b.noteSize;Browser.sendToTab(c.tab,b);delete r[a.pendingNoteKey]});return}delete b.noteSize;Browser.sendToTab(c.tab,b);delete r[a.pendingNoteKey]}else"showSyncing"===b.name&&Browser.sendToTab(c.tab,{name:"showSyncing"})}
r[a.pendingNoteKey]||(r[a.pendingNoteKey]={});r[a.pendingNoteKey].note=a;r[a.pendingNoteKey].originatingTab=c;b=[];if(a.smartFilingNotebookAvailable){var g="accepted_notebook_suggestion";a.changedSmartFilingNotebook&&(g="changed_from_",a.changedSmartFilingNotebook.from.type===GlobalUtils.NOTEBOOK_TYPE_PERSONAL?g+="personal":a.changedSmartFilingNotebook.from.type===GlobalUtils.NOTEBOOK_TYPE_BUSINESS&&(g+="business"),g+="_to_",g=a.changedSmartFilingNotebook.to.defaultNotebook?g+"default":a.changedSmartFilingNotebook.to.recentNotebook?
g+"last_used":g+"another",g+="_",a.changedSmartFilingNotebook.to.type===GlobalUtils.NOTEBOOK_TYPE_PERSONAL?g+="personal":a.changedSmartFilingNotebook.to.type===GlobalUtils.NOTEBOOK_TYPE_LINKED?g+="shared":a.changedSmartFilingNotebook.to.type===GlobalUtils.NOTEBOOK_TYPE_BUSINESS&&(g+="business"),g+="_notebook");b.push({slot:Analytics.CD.SMART_FILING,value:g})}b.push({slot:Analytics.CD.TAG,value:a.tags&&0<a.tags.length?"added_tags":"no_tags"});b.push({slot:Analytics.CD.COMMENTS,value:a.comment&&a.comment.trim()?
"added_comments":"no_comments"});b.push({slot:Analytics.CD.EXPORT_TO_DB,value:1});s({category:"Clip",action:a.clipType,startSession:!0,data:b});a.notebook||(a.notebook={type:GlobalUtils.NOTEBOOK_TYPE_PERSONAL});var k=options.get("secureProto")+m.get("serviceHost");auth.isAuthenticated(function(b){if(a.error)log.error((c&&c.tab?c.tab.url+"\n\n":"")+a.error),c&&c.tab&&c.tab.url&&s({category:"Errors",action:"Serializer",label:c.tab.url}),e({name:"fail",error:a.error},b);else{if(a.userSelectedNotebook&&
a.notebook.guid){var d=Persistent.get("recentNotebooks");d||(d={});d[b.userId]=a.notebook.guid;Persistent.set("recentNotebooks",d)}a.notebook.type===GlobalUtils.NOTEBOOK_TYPE_PERSONAL?l(b.authenticationToken,!1,b):a.notebook.type===GlobalUtils.NOTEBOOK_TYPE_LINKED?(new RSVP.Promise(function(c,d){ia(a.notebook.shardId).authenticateToSharedNotebook(a.notebook.globalId,b.authenticationToken,c,d)})).then(function(a){l(a.authenticationToken,!0,b)},function(a){log.error("Error authenticating to shared notebook: "+
a.__proto__.name+JSON.stringify(a));e({name:"fail",error:a},b)}):a.notebook.type===GlobalUtils.NOTEBOOK_TYPE_BUSINESS&&l(b.bizAuthenticationToken,!1,b)}})}function N(a,c){(/PERMISSION_DENIED/.test(a.trace)||/AUTH_EXPIRED/.test(a.trace))&&/parameter:authenticationToken\)/.test(a.trace)?(L({authExpired:!0},{tab:c}),c&&Browser.sendToTab(c,{name:"tellUserToLogin"})):log.error(a.trace||a.message||a.stack||a)}function ja(){function a(a,c){var b=/^https:\/\/(?:stage|stage-china|www|app)\.(?:evernote|yinxiang)\.com\/.+?ssoReturnStatus=(.+?)(?:&|$)/.exec(a);
b&&c(b[1])}function c(b,f){a(f.url,function(a){chrome.tabs.onUpdated.removeListener(c);"SUCCESS"===a&&chrome.tabs.remove(b,function(){O()})})}function b(c){a(c.target.url,function(a){safari.application.removeEventListener("navigate",b);"SUCCESS"===a&&(c.target.close(),O())})}M({url:ea("secureProto")+y("serviceHost")+"/SetAuthToken.action?auth="+encodeURIComponent(auth.getUserInfo().authenticationToken)+"&targetUrl="+encodeURIComponent("/business/BusinessSecurityLogin.action?u="+auth.getCurrentUser()+
"&h="+sjcl.codec.hex.fromBits(sjcl.hash.sha1.hash(auth.getUserInfo().authenticationToken))+"&clipper=true"),type:"popup",width:1012,height:435},null,function(){SAFARI?safari.application.addEventListener("navigate",b):chrome.tabs.onUpdated.addListener(c)})}function O(a,c,b){auth.isAuthenticated(function(a){a?c&&c.tab?Browser.sendToTab(c.tab,{name:"updateUserTier",bizUser:!!a.businessId,bizComplete:!!a.bizAuthenticationToken}):Browser.getCurrentTab(function(c){c&&Browser.sendToTab(c,{name:"updateUserTier",
bizUser:!!a.businessId,bizComplete:!!a.bizAuthenticationToken})}):log.error("logged out while checking if SSO is done")})}function ia(a){a=new Thrift.BinaryHttpTransport(options.get("secureProto")+m.get("serviceHost")+"/edam/note/"+a);a=new Thrift.BinaryProtocol(a);return new NoteStoreClient(a)}function sa(a){a=new Thrift.BinaryHttpTransport(options.get("secureProto")+m.get("serviceHost")+"/shard/"+a+"/utility");a=new Thrift.BinaryProtocol(a);return new UtilityClient(a)}function Y(a,c,b){Browser.captureVisibleTab(c.tab,
function(d){if(a.start&&a.end){var f=document.createElement("canvas"),l=new Image;l.onload=function(){var b=this.height/a.screenshotHeight;f.width=b*(a.end.x-a.start.x+1);f.height=b*(a.end.y-a.start.y+1);f.getContext("2d").drawImage(this,b*a.start.x,b*a.start.y,f.width,f.height,0,0,f.width,f.height);Browser.sendToTab(c.tab,{name:"receiveScreenshot",data:f.toDataURL()});f=null};l.src=d;s({category:"Skitch",action:"take_screenshot",label:"portion"})}else a.contextMenu?b(d):Browser.sendToTab(c.tab,{name:"receiveScreenshot",
data:d}),s({category:"Skitch",action:"take_screenshot",label:"whole"})})}var I="content/auth_tools/login.html",H=!1,ka=!0,r={},m,D,C;A=E=null;var P=!1,t;window.addEventListener("offline",function(a){log.log("Went offline.")});window.addEventListener("online",function(a){log.log("Went online.");if(0<Object.keys(r)){log.log("processing offline clips");for(var c in r)ha(r[c].note,r[c].originatingTab)}});var p={clipPage:"EN_safariContextClipPage",clipScreenshot:"EN_safariContextClipScreenshot",clipSelection:"EN_safariContextClipSelection",
clipImage:"EN_safariContextClipImage",clipPDF:"EN_safariContextClipPDF",clipUrl:"EN_safariContextClipUrl"};SAFARI&&(safari.application.addEventListener("contextmenu",pa,!1),safari.application.addEventListener("command",oa,!1));Browser.addMessageHandlers({LOGOUT:L,main_isAuthenticated:da,ssoComplete:O,main_getTextResource:function(a,c,b){function d(){if(this.readyState==this.DONE){var a={name:"content_textResource",href:this.href};200==this.status&&(a.responseText=this.responseText);Browser.sendToTab(c.tab,
a)}}a&&a.href&&(b=new XMLHttpRequest,b.href=a.href,b.open("GET",a.href),b.onreadystatechange=d,b.send())},simSearch_getNotesRelatedToSearchQuery:function(a,c,b){Browser.sendToTab(c.tab,{name:"getInfo"})},simSearch_receivePageInfo:function(a,c,b){function d(){var b;if("Google"!==a.info.searchEngine&&n.bizAuthenticationToken){var d=Math.max(3-w.length,2),f=[];b=[];for(var e=0;e<h.length&&!(f.length>=d&&b.length>=d);e++)h[e].shardId=q.shardId,h[e].inBusinessNotebook=!0,s[h[e].notebookGuid].joined?f.push(h[e]):
(h[e].notebookName=s[h[e].notebookGuid].name,h[e].contact=h[e].attributes.lastEditedBy||h[e].attributes.author||s[h[e].notebookGuid].contact,b.push(h[e]));for(var e=Math.min(d,f.length),e=Math.max(d-e,1),g=Math.min(e,b.length),d=f.slice(0,d-g),e=0;e<g;e++)d.push(b[e]);b=w.slice(0,3-d.length);for(e=0;e<d.length;e++)b.push(d[e]);0<x.length&&(b[Math.max(0,b.length-1)]=x[0]);b=0<b.length?b:null;Browser.sendToTab(c.tab,{name:"simsearch_receiveRelatedNotes",relatedNotes:b,type:"all",tokens:{pers:n.authenticationToken,
biz:n.bizAuthenticationToken},noSimsearchResultsShown:Persistent.get(n.userId+"_noSimsearchResultsShown")})}else{if(n.bizAuthenticationToken){d=[];b=[];for(f=0;f<h.length&&!(3<=d.length&&3<=b.length);)h[f].shardId=q.shardId,h[f].inBusinessNotebook=!0,s[h[f].notebookGuid].joined?d.push(h[f]):(h[f].notebookName=s[h[f].notebookGuid].name,h[f].contact=h[f].attributes.lastEditedBy||h[f].attributes.author||s[h[f].notebookGuid].contact,b.push(h[f])),f++;f=Math.max(3-d.length,1);f=Math.min(f,b.length);h=
d.slice(0,3-f);for(d=0;d<f;d++)h.push(b[d]);0<x.length&&(h[Math.max(0,h.length-1)]=x[0]);b=[];0<w.length&&(b[0]=w);0<h.length&&(b[1]=h)}else b=0<w.length?[w]:[];Browser.sendToTab(c.tab,{name:"simsearch_receiveRelatedNotes",relatedNotes:b[0],type:"account",isBizUser:Boolean(n.bizAuthenticationToken),tokens:{pers:n.authenticationToken,biz:n.bizAuthenticationToken},noSimsearchResultsShown:Persistent.get(n.userId+"_noSimsearchResultsShown")});n.bizAuthenticationToken&&Browser.sendToTab(c.tab,{name:"simsearch_receiveRelatedNotes",
relatedNotes:b[1],type:"library",tokens:{pers:n.authenticationToken,biz:n.bizAuthenticationToken},noSimsearchResultsShown:Persistent.get(n.userId+"_noSimsearchResultsShown")})}}function f(b,f){b?(w=b.relatedNotes?b.relatedNotes.list:[],b.debugInfo&&(u.write("QUERY",a.info.query),u.write("TEXT",a.info.recommendationText),u.write("DEBUG_INFO",b.debugInfo)),(n.bizAuthenticationToken&&h&&x||!n.bizAuthenticationToken)&&d()):N(f,c.tab)}function l(a,b){if(a){if(a.relatedNotes){for(var f=0;f<a.containingNotebooks.list.length;f++){var e=
a.containingNotebooks.list[f];s[e.guid]={joined:e.hasSharedNotebook,name:e.notebookDisplayName,contact:e.contactName}}h=a.relatedNotes.list}else h=[];a.debugInfo&&u.write("DEBUG_INFO",a.debugInfo);w&&x&&d()}else N(b,c.tab)}function e(a,b){x=[];a?a.experts&&a.experts.list&&0<a.experts.list.length&&x.push({title:a.experts.list[0].name,id:a.experts.list[0].id,type:"expert",role:a.experts.list[0].attributes?a.experts.list[0].attributes.title:null}):N(b,c.tab);w&&h&&d()}function g(){var c={includeTitle:!0,
includeUpdated:!0,includeAttributes:!0,includeNotebookGuid:!0};options.get("includeDebugInfo")&&(c.includeDebugInfo=!0);var c={url:a.info.url,text:a.info.recommendationText,query:a.info.query,relatedNotesResultSpec:c},b=options.get("relatedNotesContext").trim();""!=b&&(c.context=b);return c}function k(){JsonQueue.handleExpensiveOpRequest({shardId:t.shardId,userId:n.userId,type:"pers"},t.client.NoteStoreExtra.getFilingRecommendations,f,n.authenticationToken,g())}function p(){JsonQueue.handleExpensiveOpRequest({shardId:q.shardId,
userId:n.userId,type:"biz"},q.client.NoteStoreExtra.getFilingRecommendations,l,n.bizAuthenticationToken,g());q.client.NoteStore.findRelated(e,n.bizAuthenticationToken,{plainText:a.info.query},{maxExperts:1})}function r(a){n=a;v=options.get("secureProto")+m.get("serviceHost");t=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations","NoteStore.listLinkedNotebooks"],v,options.get("secureProto"),m.get("serviceHost"),options.get("overrideServiceURL"));t.initWithAuthToken(n.authenticationToken,k);
n.bizAuthenticationToken&&(q=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations","NoteStore.findRelated"],v,options.get("secureProto"),m.get("serviceHost"),options.get("overrideServiceURL")),q.initWithAuthToken(n.bizAuthenticationToken,p))}var t,q,w,h,x,s={},n,v,u=new LogWriter("relatedNotesDebugInfo");a.info.recommendationText&&a.info.query&&auth.isAuthenticated(r)},togglePDFContextMenuOption:function(a,c,b){SAFARI||a.show==ka||((ka=a.show)?Q():chrome.contextMenus.remove("pdf"))},getKeyboardShortcuts:function(a,
c,b){if(c&&c.tab){b={};for(var d=0;d<a.shortcuts.length;d++)b[a.shortcuts[d]]=options.get(a.shortcuts[d]);Browser.sendToTab(c.tab,{name:"receiveKeyboardShortcuts",keys:b,keyboardShortcutsEnabled:options.get("enableKeyboardShortcuts")})}},main_setOption:function(a,c,b){for(var d in a.options)options.set(d,a.options[d]);b&&b()},main_clearOptions:function(a,c,b){options.clear(a.options);b={};for(var d in a.options)b[a.options[d]]=options.get(a.options[d]);Browser.sendToTab(c.tab,{name:"optionsCleared",
options:b})},main_getConfig:function(a,c,b){if(c&&c.tab){var d={name:"config"};a.returnName&&(d.name=a.returnName);if(a.options){d.options={};for(var f in a.options)d.options[f]=options.get(f)}if(a.bootstrapInfo)for(f in d.bootstrapInfo={},a.bootstrapInfo)m&&(d.bootstrapInfo[f]=m.get(f));Browser.sendToTab(c.tab,d);b&&b(d)}},main_openTab:fa,main_openWindow:M,main_restart:ca,main_recordActivity:ga,main_getL10n:function(a,c,b){Browser.sendToTab(c.tab,{name:"l10nData",data:Browser.i18n._getL10nData()});
b&&b()},bounce:function(a,c,b){c.tab&&Browser.sendToTab(c.tab,a.message)},bounceToAll:function(a,c,b){Browser.getAllTabs(function(c){for(var b=0;b<c.length;b++)Browser.sendToTab(c[b],a.message)})},insertCSS:function(a,c,b){Browser.insertCSS(a.filename)},getPersistentFlag:function(a,c,b){Browser.sendToTab(c.tab,{name:"receivePersistentFlag",key:a.key,value:Persistent.get(a.key)});a.set&&Persistent.set(a.key,a.setValue)},getOption:function(a,c,b){a.name="receiveOption";"defaultClipAction"==a.option?
(a.key="clipAction","lastUsed"==options.get("defaultClipAction")?(b=Persistent.get("lastUsedAction"),a.value=b?b:"ARTICLE"):a.value=options.get("clipAction")):(a.key=a.option,a.value=options.get(a.key));delete a.option;Browser.sendToTab(c.tab,a)},submitNote:ha,toggleClipper:z,trackEvent:s,trackTiming:function(a,c,b){Analytics.trackTiming(a.category,a.variableName,a.time,a.label)},showOpenState:function(){Browser.setIcon("images/close-ext")},showLoggedInState:K,showLoggedInOrOutState:B,getPersistentValue:function(a,
c,b){c&&c.tab&&Browser.sendToTab(c.tab,{name:"receivePersistentValue",key:a.key,value:Persistent.get(a.key),currentUserId:auth.getCurrentUser()})},setPersistentValue:function(a,c,b){Persistent.set(a.key,a.value)},setPersistentValueForUser:function(a,c,b){(c=Persistent.get(a.key))||(c={});c[a.userId]=a.value;Persistent.set(a.key,c)},addToPersistentValue:function(a,c,b){(c=Persistent.get(a.key))||(c=0);c+=a.delta;Persistent.set(a.key,c)},downloadThumbnail:function(a,c,b){b=new XMLHttpRequest;b.guid=
a.guid;b.open("POST",a.url);b.responseType="arraybuffer";b.onreadystatechange=function(){if(4===this.readyState){if(200===this.status){for(var a="",b=new Uint8Array(this.response),l=0;l<b.length;l++)a+=String.fromCharCode(b[l]);Browser.sendToTab(c.tab,{name:"receiveThumbnail",guid:this.guid,datauri:"data:"+this.getResponseHeader("Content-type")+";base64,"+btoa(a)})}q.shift();0<q.length&&q[0].req.send(q[0].payload)}};b.setRequestHeader("Content-type","application/x-www-form-urlencoded");a.inBusinessNotebook?
q.push({req:b,payload:"size="+a.size+"&auth="+encodeURIComponent(auth.getUserInfo().bizAuthenticationToken)}):q.push({req:b,payload:"size="+a.size+"&auth="+encodeURIComponent(auth.getUserInfo().authenticationToken)});1===q.length&&q[0].req.send(q[0].payload)},cropImage:function(a,c,b){var d=new Image;d.onload=function(){var b=document.createElement("canvas");b.width=Math.min(150,a.width);b.height=Math.min(150,a.height);b.getContext("2d").drawImage(d,Math.max(0,(a.width-150)/2),Math.max(0,(a.height-
150)/2),b.width,b.height,0,0,b.width,b.height);Browser.sendToTab(c.tab,{name:"receiveCroppedImage",datauri:b.toDataURL(),url:a.url})};d.src=a.url},tourLoaded:function(a,c,b){D=c.tab.id;C=c.tab.url;a=c.tab;Browser.sendToTab(a,{name:"toggleCoordinator",baseUrl:options.get("secureProto")+m.get("serviceHost"),userId:"fake",username:Browser.i18n.getMessage("fleFakeUser"),authTokens:{},premium:!1,fullName:Browser.i18n.getMessage("fleFakeUser"),dontStartPreview:!0});Browser.sendToTab(a,{name:"startTour"});
b&&b()},finishTour:function(a,c,b){C=D=null},isTouring:function(a,c,b){a=$(c.tab);Browser.sendToTab(c.tab,{name:"isTouring",data:a});b&&b()},loadXMLHttpRequest:function(a,c,b){var d=new XMLHttpRequest;d.onreadystatechange=function(){4===d.readyState&&Browser.sendToTab(c.tab,{name:"receiveXMLHttpRequest",response:d.responseText})};d.open("GET",a.url);d.send()},tabLoaded:function(a,c,b){c&&c.tab&&(a=c.tab,console.log("Autorun"),a.id===E&&A&&(c=A,E=A=null,console.log("Executed"),c(a)))},sendAppFeedback:function(a,
c,b){auth.isAuthenticated(function(b){if(b){var c=options.get("secureProto")+m.get("serviceHost"),c=new Thrift.BinaryHttpTransport(c+"/shard/"+b.shardId+"/utility"),c=new Thrift.BinaryProtocol(c),c=new UtilityClient(c),l=new AppFeedback,e=new SupportTicket;e.applicationVersion=Browser.EVERNOTE_VERSION;e.contactEmail=auth.getUserInfo(b.userId).email;e.osInfo=a.os;e.deviceInfo=a.browser;e.subject=a.title;e.issueDescription="User agent: "+navigator.userAgent+"\nLanguage: "+navigator.language+"\n\n"+
a.details;l.rating=a.rating;l.feedback=e;c.sendAppFeedback(b.authenticationToken,l,function(a){console.log(a)},function(a){log.error("problem sending app feedback: Error code "+a.errorCode+"\n"+a)})}else log.error("logged out while filing a support ticket")})},generateSecret:function(a,c,b){c&&c.tab&&Browser.sendToTab(c.tab,{name:"receiveSecret",secret:UUID.generateGuid(),for:a.for})},showAlert:function(a,c,b){alert(a.msg)},determineSalesforcePromoEligibility:function(a,c,b){a=auth.getCurrentUser();
b=auth.getUserInfo();if(a&&!/china/i.test(m.getName())&&!b.businessId){var d=a%10;if(1<=d&&4>=d){var f=Persistent.get("promo_salesforce");f||(f={});f[a]||(f[a]=0);11>f[a]&&(0==f[a]%5?(Persistent.set("promo_salesforce",f),Browser.sendToTab(c.tab,{name:"isEligibleForSalesforcePromo",design:2>=d?"A":"B",userType:b.premium?"premium":"free"})):(f[a]++,Persistent.set("promo_salesforce",f)))}}},addToSalesforceCounter:function(a,c,b){if(c=auth.getCurrentUser())b=Persistent.get("promo_salesforce"),b[c]+=a.inc,
Persistent.set("promo_salesforce",b)},checkInactivityPeriod:function(a,c,b){a=(a=auth.getCurrentUser())?a:"unauthed";(b=Persistent.get("lastActiveTimes"))&&b[a]&&5>b[a].count&&b[a].time+216E7<=new Date&&Browser.sendToTab(c.tab,{name:"nudgeInactiveUser",locale:y("name"),authed:"unauthed"===a?!1:!0})},updateLastActiveTime:function(a,c,b){a=Persistent.get("lastActiveTimes");c=(c=auth.getCurrentUser())?c:"unauthed";a[c].time=(new Date).getTime();a.unauthed.time=a[c].time;a[c].count++;Persistent.set("lastActiveTimes",
a)},openSSOPage:ja,captureScreenshot:Y});var q=[];this.setOption=function(a,c){options.set(a,c)};this.getOption=ea;this.getBootstrapInfo=y;this.getBootstrapInfoLength=Z;this.start=function(){Persistent.get("deviceID")||Persistent.set("deviceID",UUID.generateGuid().slice(0,32));Persistent.hasKey("BootstrapInfoIndex")&&Persistent.hasKey("BootstrapInfo")?F(!0):(new Bootstrapper(options.get("simulateSimplifiedChinese"),options.get("useStage"),options.get("overrideServiceURL"),options.get("secureProto"))).bootstrap(F,
!0)};this.startUp=F;this.createNoteStoreClient=ia;this.showLoggedInState=K;this.showLoggedOutState=ba;this.msgHandlerIsAuthenticated=da;this.msgHandlerLogin=function(a,c,b){auth.login(a.username,a.password,function(a){a.error||(!a.bizAuthenticationToken&&!a.bizName||Persistent.get(a.userId+"_turnedOffSearchHelper")||options.set("useSearchHelper",!0),a.username&&(Browser.setBrowserActionClickHandler(function(a){z(null,{tab:a})}),Browser.setPopup("")));b(a)})};this.msgHandlerSubmitTwoStepCode=function(a,
c,b){auth.completeTwoFactorAuthentication(a.auth,a.code,function(a){a.error||(Browser.setBrowserActionClickHandler(function(a){z(null,{tab:a})}),Browser.setPopup(""));Browser.getCurrentTab(function(c){a.currentTab=c;b(a)})})};this.msgHandlerGetRegistrationLinks=function(a,c,b){a="clipper_chr";SAFARI?a="clipper_saf":OPERA?a="clipper_op":YANDEX&&(a="clipper_yan");c=new FormData;c.append("code",a);var d=new XMLHttpRequest;d.open("POST",options.get("secureProto")+m.get("serviceHost")+"/CreateUserJSON.action?",
!0);d.onreadystatechange=function(){if(4==d.readyState&&200==d.status){var a=JSON.parse(d.response);b({captcha:a.captcha,submit:a.submit})}else 0==d.status?(log.error("couldn't get registration form links because of network error"),b({error:"NETWORK"})):4==d.readyState&&log.error("couldn't get registration form links because of error: "+d.status)};d.send(c)};this.switchService=function(a,c,b){1<m.getLength()&&(a=m.getIndex(),m.setIndex((a+1)%2),b())};this.msgHandlerLogout=L;this.msgHandlerOpenTab=
fa;this.msgHandlerOpenWindow=M;this.msgHandlerRestart=ca;this.msgHandlerRecordActivity=ga;this.toggleClipper=z;this.openSSOPage=ja;this.getPendingNote=function(a){return r[a]};this.setPendingNote=function(a,c){r[a]=c};this.combineRelatedNotes=function(a,c,b,d,f){var l=[],e=Math.max(3-a.length,2),g=[],l=[];a||(a=[]);b||(b=[]);for(var k=0;k<b.length&&!(g.length>=e&&l.length>=e);k++)b[k].shardId=d,b[k].inBusinessNotebook=!0,f[b[k].notebookGuid].joined?g.push(b[k]):(b[k].notebookName=f[b[k].notebookGuid].name,
l.push(b[k]));k=Math.min(e,g.length);k=Math.max(e-k,1);b=Math.min(k,l.length);e=g.slice(0,e-b);for(k=0;k<b;k++)e.push(l[k]);l=a.slice(0,3-e.length);for(k=0;k<e.length;k++)l.push(e[k]);for(k=0;k<l.length;k++)l[k].shardId||(l[k].shardId=c);return l};this.trackEvent=s;this.generateUserCustomDimensions=R;Object.preventExtensions(this)}Object.preventExtensions(Extension);var extension=new Extension,auth=null;extension.start();
