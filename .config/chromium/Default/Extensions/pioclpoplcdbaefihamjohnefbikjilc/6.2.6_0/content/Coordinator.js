function Coordinator(){function u(a,b,c){!g.classList.contains("evernoteClipperVisible")||document.documentElement.classList.contains("evernoteOptionsOpen")?(g.classList.remove("evernoteClipperVisible"),z()):(g.addEventListener("webkitTransitionEnd",z),g.classList.remove("evernoteClipperVisible"));f&&f.parentNode&&(f.parentNode.removeChild(f),f=null);document.documentElement.classList.remove("evernoteOptionsOpen");contentPreview.clear();b=a.notClipping;h&&(h.getElement()&&h.getElement().parentNode&&
h.getElement().parentNode.removeChild(h.getElement()),b&&h.destroy());b&&(h=null);document.documentElement.classList.remove("skitchWaiting","skitchReady");a.notClipping&&(contentPreview.reset(),contentPreview.clearHighlights());window.removeEventListener("keydown",B);window.removeEventListener("keypress",C);window.removeEventListener("mousedown",D);window.removeEventListener("unload",E);Browser.sendToExtension({name:"showLoggedInOrOutState"})}function J(a,b,c){document.documentElement.classList.contains("evernoteOptionsOpen")?
F({authed:!0}):g.classList.contains("evernoteClipperVisible")&&(c?u({notClipping:!0}):Browser.sendToExtension({name:"bounce",message:{name:"gt_handleEscape",keycode:a}}))}function G(a){g.classList.contains("evernoteClipperVisible")&&!document.documentElement.classList.contains("skitchReady")&&("notebook"===a?Browser.sendToExtension({name:"bounce",message:{name:"gt_openNotebook"}}):"tags"===a&&Browser.sendToExtension({name:"bounce",message:{name:"gt_openTags"}}))}function w(a){g.classList.contains("evernoteClipperVisible")&&
!document.documentElement.classList.contains("skitchReady")&&("expand"==a?contentPreview.expandPreview():"contract"==a?contentPreview.contractPreview():"up"==a?contentPreview.moveToElementAbove():"down"==a&&contentPreview.moveToElementBelow())}function H(a,b){if(l&&c[a])c[a](a,b)}function q(a,b){if(c[a])c[a](a,b)}function F(a,b,c){a.authed?(Browser.sendToExtension({name:"bounce",message:{name:"gt_reactivateClipperTool"}}),f&&f.parentNode&&(f.parentNode.removeChild(f),f=null),document.documentElement.classList.remove("evernoteOptionsOpen")):
u({notClipping:!0})}function A(a,b,c){2===v?(n&&n.parentNode&&n.parentNode.removeChild(n),g.classList.contains("evernoteClipperVisible")?u({notClipping:!0}):(clipResultCoordinator.hideClipResult(!1),a&&(Browser.sendToExtension({name:"main_recordActivity"}),x=a.bizUser,y=a.bizComplete,Browser.sendToExtension({name:"bounce",message:{name:"gt_initialize",ssoRequired:x&&!y,title:pageInfo.getTitle()}}),Browser.sendToExtension({name:"bounce",message:{name:"gt_setPossibleClipTypes",pageInfo:{pdf:pageInfo.getPdfUrl(),
documentIsFrameset:pageInfo.documentIsFrameset,selection:pageInfo.getSelection()?!0:!1,gmail:pageInfo.isGmail(),gmailThread:pageInfo.isGmailThread()}}}),r=UUID.generateGuid(),Browser.sendToExtension({name:"getSmartFilingInfo",recText:pageInfo.getRecommendationText(!1),pendingNoteKey:r})),g.addEventListener("webkitTransitionEnd",I),g.classList.add("evernoteClipperVisible"),Browser.sendToExtension({name:"showOpenState"}),Browser.sendToExtension({name:"bounce",message:{name:"ttc_close",which:"gmailTooltip"}}),
Browser.sendToExtension({name:"bounce",message:{name:"ttc_close",which:"pdfTooltip"}}))):(s=[a,b,c],n=document.createElement("div"),n.id="evernoteLoading",document.body.appendChild(n),document.documentElement.appendChild(g),window.addEventListener("keydown",B),window.addEventListener("keypress",C),window.addEventListener("mousedown",D),window.addEventListener("unload",E),Browser.sendToExtension({name:"getKeyboardShortcuts",shortcuts:"closeWebClipperShortcut previewArticleShortcut previewFullPageShortcut previewUrlShortcut selectionModeShortcut takeScreenshotShortcut clearlyShortcut pdfShortcut emailShortcut expandArticleShortcut contractArticleShortcut moveArticleUpShortcut moveArticleDownShortcut selectNotebookShortcut addTagsShortcut saveShortcut arrowShortcut textShortcut rectangleShortcut roundedRectangleShortcut ellipseShortcut lineShortcut markerShortcut highlighterShortcut stampShortcut pixelateShortcut cropShortcut".split(" ")}),
v++)}function z(){g&&(g.removeEventListener("webkitTransitionEnd",z),g.parentNode&&g.parentNode.removeChild(g));v=0}function I(a){"opacity"===a.propertyName&&(Browser.sendToExtension({name:"getOption",option:"defaultClipAction"}),g.removeEventListener("webkitTransitionEnd",I))}function B(a){/Mac OS X/.test(window.navigator.userAgent)?a.metaKey&&a.preventDefault():/Windows/.test(window.navigator.userAgent)&&a.ctrlKey&&a.preventDefault();-1<[8,13,27,39,37,65,70,66,83,77,80,69,67].indexOf(a.keyCode)?
document.documentElement.classList.contains("skitchReady")||document.documentElement.classList.contains("skitchWaiting")||a.preventDefault():9===a.keyCode&&g.focus()}function C(a){if(document.documentElement.classList.contains("skitchReady")&&!document.querySelector("textarea.skitch-tool-element-text-editor")){var b=h.getElement().offsetWidth/2,c=h.getElement().offsetHeight/2;Browser.sendToExtension({name:"bounce",message:{name:"gt_useSkitchTool",tool:"text",loc:{x:b,y:c},charCode:a.charCode}});a.preventDefault()}}
function D(a){g.classList.contains("evernoteClipperVisible")?a.srcElement!==document.documentElement&&contentPreview.isPointOnVeil(a.pageX,a.pageY)&&a.preventDefault():document.documentElement.classList.contains("evernoteOptionsOpen")&&a.preventDefault()}function E(){Browser.sendToExtension({name:"showLoggedInOrOutState"})}function K(){g.classList.contains("evernoteClipperVisible")&&Browser.sendToExtension({name:"bounce",message:{name:"gt_save"}})}function m(a){g.classList.contains("evernoteClipperVisible")&&
!document.documentElement.classList.contains("skitchReady")&&Browser.sendToExtension({name:"bounce",message:{name:"gt_useClipType",clipType:a}})}function k(a,b){document.documentElement.classList.contains("skitchReady")&&Browser.sendToExtension({name:"bounce",message:{name:"gt_useSkitchTool",tool:a,subtool:b}})}function L(a,b){b&&(-1<["INPUT","TEXTAREA"].indexOf(b.nodeName)||"true"===b.contentEditable)||Browser.sendToExtension({name:"toggleClipper"},function(){alert("The Clipper couldn't start on this page. Reload the page and try again. If that doesn't help, contact customer support.")})}
var g,f,n,h,l=!0,c={},p={},t={},r,v=0,s=[],x,y;this.msgHandlerToggleCoordinator=A;Browser.addMessageHandlers({closeClipper:u,duplicateKeyboardShortcut:function(a,b,g){if("function"===typeof c[a.keycode])c[a.keycode](a.keycode,null,!0)},goToSkitchWaitingMode:function(){document.documentElement.classList.add("skitchWaiting")},hideOptions:F,receiveKeyboardShortcuts:function(a,b,h){l=a.keyboardShortcutsEnabled;b={};for(var e in a.keys){h=a.keys[e].split("|");var d=h.join(" + ");b[d]=H;p[e]=[d];"startWebClipperShortcut"==
e?c[d]=L:"closeWebClipperShortcut"==e?(b[d]=q,c[d]=J,t[e]=[d]):"previewArticleShortcut"==e?c[d]=function(){m("article")}:"previewFullPageShortcut"==e?c[d]=function(){m("fullPage")}:"previewUrlShortcut"==e?c[d]=function(){m("url")}:"selectionModeShortcut"==e?c[d]=function(){m("selection")}:"takeScreenshotShortcut"==e?c[d]=function(){m("screenshot")}:"clearlyShortcut"==e?c[d]=function(){m("clearly")}:"pdfShortcut"==e?c[d]=function(){m("pdf")}:"emailShortcut"==e?c[d]=function(){m("email")}:"expandArticleShortcut"==
e?(b[d]=q,c[d]=function(){w("expand")}):"contractArticleShortcut"==e?(b[d]=q,c[d]=function(){w("contract")}):"moveArticleUpShortcut"==e?(b[d]=q,c[d]=function(){w("up")}):"moveArticleDownShortcut"==e?(b[d]=q,c[d]=function(){w("down")}):"selectNotebookShortcut"==e?c[d]=function(){G("notebook")}:"addTagsShortcut"==e?c[d]=function(){G("tags")}:"saveShortcut"==e?c[d]=K:"arrowShortcut"==e?c[d]=function(){k("shapes","arrow")}:"textShortcut"==e?c[d]=function(){k("text")}:"rectangleShortcut"==e?c[d]=function(){k("shapes",
"rectangle")}:"roundedRectangleShortcut"==e?c[d]=function(){k("shapes","roundedRectangle")}:"ellipseShortcut"==e?c[d]=function(){k("shapes","ellipse")}:"lineShortcut"==e?c[d]=function(){k("shapes","line")}:"markerShortcut"==e?c[d]=function(){k("marker")}:"highlighterShortcut"==e?c[d]=function(){k("highlighter")}:"stampShortcut"==e?c[d]=function(){k("stamps")}:"pixelateShortcut"==e?c[d]=function(){k("pixelate")}:"cropShortcut"==e&&(c[d]=function(){k("crop")});if(-1<h.indexOf("91")){var f=JSON.parse(JSON.stringify(h));
/windows/i.test(window.navigator.userAgent)?(f[h.indexOf("91")]="17",f.sort(function(a,b){return a-b}),c[f.join(" + ")]=c[d],delete c[d],b[f.join(" + ")]=b[d],delete b[d],p[e]&&(p[e][0]=f.join(" + ")),t[e]&&(t[e][0]=f.join(" + "))):(f[h.indexOf("91")]="93",f.sort(function(a,b){return a-b}),c[f.join(" + ")]=c[d],b[f.join(" + ")]=b[d],p[e]&&p[e].push(f.join(" + ")),t[e]&&t[e].push(f.join(" + ")))}}Browser.addKeyboardHandlers(b);g&&g.parentNode&&Browser.sendToExtension({name:"bounce",message:{name:"gt_setKeyboardHandlers",
handlers:p,enabled:l}})},receiveKeyboardShortcutsEnabled:function(a,b,c){l=a.keyboardShortcutsEnabled;Browser.sendToExtension({name:"bounce",message:{name:"gt_setKeyboardHandlers",enabled:l}});Browser.sendToExtension({name:"bounce",message:{name:"op_setKeyboardHandlers",enabled:l}})},receiveScreenshot:function(a,b,c){h=Markup({allowZoom:!1,container:document.body,document:a.data,margin:0,enableToolbar:!1,fullScreen:!0,success:function(){document.documentElement.classList.add("skitchReady");h.toast(Browser.i18n.getMessage("screenshotToast"));
Browser.sendToExtension({name:"bounce",message:{name:"skitchSurfaceReady"}})}});h.on("toolStarted",function(a){Browser.sendToExtension({name:"trackEvent",category:"Skitch",action:a})});h.on("toolStopped",function(a){"crop"===a&&g.style.removeProperty("display")});h.localize({CROP_APPLY_TEXT:Browser.i18n.getMessage("apply"),CROP_CANCEL_TEXT:Browser.i18n.getMessage("regForm_cancel"),MARKUP_STAMP_APPROVED_TEXT:Browser.i18n.getMessage("approved"),MARKUP_STAMP_EXCLAIM_TEXT:Browser.i18n.getMessage("wow"),
MARKUP_STAMP_PERFECT_TEXT:Browser.i18n.getMessage("perfect"),MARKUP_STAMP_QUESTION_TEXT:Browser.i18n.getMessage("what"),MARKUP_STAMP_REJECTED_TEXT:Browser.i18n.getMessage("rejected"),ZOOM_RESET_TEXT:Browser.i18n.getMessage("reset"),ZOOM_TIP_TEXT:Browser.i18n.getMessage("panInstruction")})},setGlobalToolsHeight:function(a,b,c){g.style.setProperty("height",a.height+"px","important")},setOptionsHeight:function(a,b,c){a.height>window.innerHeight?(f.style.setProperty("height",window.innerHeight+"px","important"),
f.style.setProperty("top","-webkit-calc(50% - "+window.innerHeight/2+"px)","important"),Browser.sendToExtension({name:"bounce",message:{name:"op_setPinchHeight",totalHeight:window.innerHeight}})):(f.style.setProperty("height",a.height+"px","important"),f.style.setProperty("top","-webkit-calc(50% - "+a.height/2+"px)","important"))},showOptions:function(a,b,c){f||(f=document.createElement("iframe"),f.id="evernoteOptionsPage",f.addEventListener("load",function(){Browser.sendToExtension({name:"bounce",
message:{name:"op_setKeyboardHandlers",handlers:t,enabled:l}})}),f.src=Browser.extension.getURL("options.html#iframe"));document.documentElement.appendChild(f);document.documentElement.classList.add("evernoteOptionsOpen");contentPreview.gray();f.focus()},showSSOProgressTooltip:function(a,b,c){new TooltipCoordinator(Browser.extension.getURL("content/tooltips/tooltip.html#authed=true&which=ssoInProgress"),"ssoInProgress","evernoteSSOProgress")},startSubmission:function(a,b,c){function e(b,c){"screenshot"===
a.clipType?a.screenshotUrl?b():h.getFile(function(a){h.destroy();h=null;b({bytes:a.bytes,byteLength:a.bytes.byteLength})}):"clearly"===a.clipType?clipper.clipClearly(b,c):"article"===a.clipType?clipper.clipArticle(!0,b,c):"fullPage"===a.clipType?clipper.clipFullPage(!0,b,c):"selection"===a.clipType?clipper.clipSelection(!0,a.selectionText,b,c):"url"===a.clipType?clipper.clipUrl(b):"pdf"===a.clipType?clipper.clipPdf(b):"email"===a.clipType?clipper.clipEmail(b,c):"image"===a.clipType&&clipper.clipImage(a.imageUrl,
b)}u({notClipping:!1});var d=a.title;"string"!==typeof d&&(d=document.title);(d=GlobalUtils.removeControlCharacters(d).trim())||(d=Browser.i18n.getMessage("quickNote_untitledNote"));var f=pageInfo.getCanonicalUrl()||pageInfo.getRealUrlFromOperaPdfViewerUrl()||document.location.href;b=null;a.contextMenu&&(b=pageInfo.getRecommendationText(!1));clipResultCoordinator.showClipResult(r,d,f,b,function(){e(function(b){var c={name:"submitNote",title:d,notebook:a.notebook,tags:a.tags,comment:a.comment,clipType:a.clipType,
url:f,userSelectedNotebook:a.userSelectedNotebook,pendingNoteKey:r,smartFilingNotebookAvailable:a.smartFilingNotebookAvailable,changedSmartFilingNotebook:a.changedSmartFilingNotebook};"screenshot"===a.clipType?a.screenshotUrl?c.content='<img src="'+a.screenshotUrl+'"></img>':(c.content='<img src="resource:0"></img>',c.resources=[b]):c.content=b;Browser.sendToExtension(c);contentPreview.reset()},function(b){Browser.sendToExtension({name:"submitNote",clipType:a.clipType,error:b.stack,pendingNoteKey:r,
smartFilingNotebookAvailable:a.smartFilingNotebookAvailable,changedSmartFilingNotebook:a.changedSmartFilingNotebook});contentPreview.reset()})})},toggleCoordinator:A,updateKeyboardShortcut:function(a,b,f){"string"===typeof a.oldShortcut&&(a.oldShortcut=[a.oldShortcut],a.shortcut=[a.shortcut],a.shortcutName=[a.shortcutName]);for(b=0;b<a.oldShortcut.length;b++){var e=a.oldShortcut[b].split("|").join(" + ");f=a.shortcut[b].split("|").join(" + ");c[f]=c[e];delete c[e];e={};-1<["closeWebClipperShortcut",
"expandArticleShortcut","contractArticleShortcut","moveArticleUpShortcut","moveArticleDownShortcut"].indexOf(a.shortcutName[b])?e[f]=q:e[f]=H;Browser.addKeyboardHandlers(e)}},updateUserTier:function(a,b,c){if(x!==a.bizUser||y!==a.bizComplete)Browser.sendToExtension({name:"bounce",message:{name:"gt_updateUser",ssoRequired:a.bizUser&&!a.bizComplete}}),Browser.sendToExtension({name:"getSmartFilingInfo",recText:pageInfo.getRecommendationText(!1),pendingNoteKey:r}),x=a.bizUser,y=a.bizComplete},skitch_useColor:function(a,
b,c){h.updateSelectedElementsColor(a.color);h.useColor(a.color);Browser.sendToExtension({name:"trackEvent",category:"Skitch",action:"color",label:a.color})},skitch_useTool:function(a,b,c){h.useTool(a.tool);"crop"===a.tool?(g.style.setProperty("display","none","important"),Browser.sendToExtension({name:"trackEvent",category:"Skitch",action:"crop"})):"text"===a.tool&&a.loc&&a.charCode&&h.startActiveTool(a.loc,{value:String.fromCharCode(a.charCode),selectOnFocus:!1})},skitch_zoomIn:function(){h.zoom(1.1,
{x:window.innerWidth/2,y:window.innerHeight/2});Browser.sendToExtension({name:"trackEvent",category:"Skitch",action:"zoom_in"})},skitch_zoomOut:function(){h.zoom(1/1.1,{x:window.innerWidth/2,y:window.innerHeight/2});Browser.sendToExtension({name:"trackEvent",category:"Skitch",action:"zoom_out"})}});(function(){Browser.sendToExtension({name:"getKeyboardShortcuts",shortcuts:["startWebClipperShortcut"]});g=document.createElement("iframe");g.id="evernoteGlobalTools";g.addEventListener("load",function(){Browser.sendToExtension({name:"bounce",
message:{name:"gt_setKeyboardHandlers",handlers:p,enabled:l}});v++;0<s.length&&2===v&&(A(s[0],s[1],s[2]),s=[]);window.focus()});g.src=Browser.extension.getURL("content/global_tools/global_tools.html")})();Object.preventExtensions(this)}Object.preventExtensions(Coordinator);
