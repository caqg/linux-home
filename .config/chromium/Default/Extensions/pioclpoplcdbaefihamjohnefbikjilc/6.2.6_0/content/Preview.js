function ContentPreview(){function B(){k.parentNode||document.documentElement.appendChild(k);var a=window.getComputedStyle(k,""),b=parseInt(a.getPropertyValue("width")),a=parseInt(a.getPropertyValue("height"));b&&a&&(k.style.marginLeft=0-b/2+"px",k.style.marginTop=0-a/2+"px")}function C(a,b,d,f,s){var N={"http://localhost/favicon.ico":!0},e,g;a=GlobalUtils.createTitleAndLinkPortionOfUrlClipContent(a,b);var c=a.content,k=a.textPortion,h=a.link,m=a.url,n=document.createElement("div"),l=document.createElement("img"),
q=document.createElement("img");a=document.createElement("div");""!=f.trim()&&(a.textContent=500>f.length?f:f.slice(0,500)+"...",a.style.fontFamily="Helvetica, Arial, sans-serif",a.style.fontSize="12px",a.style.color="#0C0C0C",a.style.display="block",a.style.whiteSpace="normal",a.style.marginTop="15px",a.style.maxHeight="154px",a.style.overflow="hidden",k.appendChild(a));pageInfo.getBiggestImage(function(a){e=!0;a.src&&(n.style.position="relative",n.style.display="inline-block",n.style.width="150px",
n.style.height="150px",n.style.margin="15px 30px 0px 0px",n.style.overflow="hidden",150<a.height||150<a.width?(l.setAttribute("thumbnail",a.src),y=l,Browser.sendToExtension({name:"cropImage",height:a.height,url:a.src,width:a.width}),l.style.maxWidth="none",l.style.maxHeight="none"):l.src=a.src,l.width=Math.min(150,a.width),l.height=Math.min(150,a.height),n.appendChild(l),k.parentNode?c.insertBefore(n,k):c.appendChild(n));g&&s(c)});if(d&&!N[d.toLowerCase()])q.onload=function(){g=!0;q.style.display=
"inline-block";q.style.border="none";q.style.width="16px";q.style.height="16px";q.style.padding="0px";q.style.margin="0px 8px -2px 0px";q.width="16";q.height="16";h.insertBefore(q,m);e&&s(c)},q.onerror=function(){g=!0;e&&s(c)},q.src=d;else if(g=!0,e)return c}function m(){g.reset();g.hide();v.reset();v.removeVeil();k.parentNode&&k.parentNode.removeChild(k);t.parentNode&&t.parentNode.removeChild(t);e&&e.iframe&&(e.iframe.contentDocument.body.classList.remove("clearlyWaiting","clearlyReady"),e.iframe.classList.remove("evernoteClipperVisible"));
p&&p.disable();e&&e.iframe.contentWindow.clearlyHighlight&&e.iframe.contentWindow.clearlyHighlight.disable()}function z(a){a?(e.iframe.contentWindow.clearlyHighlight||(e.iframe.contentWindow.clearlyHighlight={settings:{imgPath:Browser.extension.getURL("clearly/images/")},window:e.iframe.contentWindow,jQuery:window.jQuery},e.iframe.contentWindow.clearlyHighlight=initClearlyComponent__highlight(e.iframe.contentWindow.clearlyHighlight),e.iframe.contentWindow.clearlyHighlight.insertCSS(),e.iframe.contentWindow.clearlyHighlight.addMouseHandlers()),
e.iframe.contentWindow.clearlyHighlight.enable()):(p||(p={settings:{imgPath:Browser.extension.getURL("clearly/images/")},window:window,jQuery:window.jQuery},p=initClearlyComponent__highlight(p),p.insertCSS(),p.addMouseHandlers()),p.enable())}function D(){if(c){var a;void 0!==typeof pageInfo&&(a=pageInfo.getSelectionFrame());a?(g.revealStaticRect(g.expandRect({width:a.width,height:a.height,top:a.offsetTop,bottom:a.height+a.offsetTop,left:a.offsetLeft,right:a.width+a.offsetLeft},-9),a,!0),g.show()):
g.outlineElement(c,!0,!0);z()}else log.warn("Couldn't find a preview element. We should switch to 'full page' mode.")}function E(){document.body.classList.add("clearlyBeforeVisible");document.documentElement.classList.add("clearlyBeforeVisible");e.iframe.classList.add("evernoteClipperVisible");z(!0)}function O(){e={callbacks:{frameCreated:function(){e.applyUnencodedOptions(e.defaultThemes.newsprint);e.loadGoogleFontsRequiredByAppliedOptions();e.iframe.addEventListener("webkitTransitionEnd",function(a){"width"===
a.propertyName&&(this.classList.contains("evernoteClipperVisible")?(document.body.classList.add("clearlyVisible"),document.documentElement.classList.add("clearlyVisible"),e.iframe.contentDocument.body.classList.add("clearlyWaiting"),0==e.pagesCount?pageInfo.getCleanArticle(function(a){if(a&&0<a.length)for(var b=0;b<a.length;b++)e.addNewPage(a[b],window.location.href),0===b&&e.iframe.contentDocument.body.classList.add("clearlyReady");else pageInfo.getDefaultArticle(function(a){a&&e.addNewPage(a.outerHTML,
window.location.href);e.iframe.contentDocument.body.classList.add("clearlyReady")})},function(a,b){e.addNewPage(a,b)}):e.iframe.contentDocument.body.classList.add("clearlyReady")):(document.body.classList.remove("clearlyVisible","clearlyBeforeVisible"),document.documentElement.classList.remove("clearlyVisible","clearlyBeforeVisible")))});var a=e.iframe.contentDocument.createElement("link");a.rel="stylesheet";a.href=Browser.extension.getURL("clearly/css/additional.css");e.iframe.contentDocument.body.appendChild(a);
e.iframe.contentWindow.loading=e.iframe.contentDocument.createElement("div");e.iframe.contentWindow.loading.id="loading";e.iframe.contentDocument.body.appendChild(e.iframe.contentWindow.loading);E()}},settings:{cssPath:Browser.extension.getURL("clearly/css/"),pageLabel:function(a){return Browser.i18n.getMessage("page",[a])},onCreateFrameUseThisId:"evernoteClearlyArticle",onCreateFrameDoNotInsertCSS:!0},window:window,jQuery:window.jQuery};e=initClearlyComponent__reformat(e);e.createFrame()}function w(a,
b){if(!a)return log.warn("Can't determine if 'null' is interesting (it's probably not)."),!1;if(a===window.document||""==a.textContent.trim()&&0===a.getElementsByTagName("img").length)return!1;var d=a.getBoundingClientRect();if(!d.width||!d.height)return!1;d=getComputedStyle(a);return"hidden"===d.visibility||"none"===d.display||a.parentNode&&b.parentNode&&(a.parentNode==b||b.parentNode==a)&&F(a,b)?!1:!0}function F(a,b){var d=a.getBoundingClientRect(),f=b.getBoundingClientRect();if(d.bottom==f.bottom&&
d.height==f.height&&d.left==f.left&&d.right==f.right&&d.top==f.top&&d.width==f.width||a.textContent===b.textContent&&a.getElementsByTagName("img").length===b.getElementsByTagName("img").length)return!1}function G(a){for(var b=0;b<a.children.length;b++){if(F(a.children[b],a))return G(a.children[b]);if(w(a.children[b],a))return a.children[b]}return a}function H(a){a.className+=" evernoteEmailSelectedMessage";a=a.children[1].firstElementChild;a.className=a.className.replace(/\s*evernoteEmailDimmed/g,
"");document.querySelectorAll(".evernoteEmail").length===document.querySelectorAll(".evernoteEmail.evernoteEmailSelectedMessage").length&&(document.querySelector("#evernoteEmailSelectAllMessages").className+=" evernoteEmailSelectedMessage")}function I(a){a.className=a.className.replace(/\s*evernoteEmailSelectedMessage/g,"");a.children[1].firstElementChild.className+=" evernoteEmailDimmed";a=document.querySelector("#evernoteEmailSelectAllMessages");a.className=a.className.replace(/\s*evernoteEmailSelectedMessage/g,
"")}function P(){for(var a="",b="#evernoteEmailPreview .evernoteEmailHeader, #evernoteEmailPreview .evernoteEmailDimmed, #evernoteEmailPreview .evernoteEmailAttachments;#evernoteEmailPreview .evernoteEmailHeader;#evernoteEmailPreview .evernoteEmailBig;#evernoteEmailPreview .evernoteEmailMedium;#evernoteEmailPreview .evernoteEmailSmall;#evernoteEmailPreview .evernoteEmailRight;#evernoteEmailPreview .evernoteEmailDimmed;#evernoteEmailPreview .evernoteEmailDivider;#evernoteEmailPreview .evernoteEmailLight;#evernoteEmailPreview .evernoteEmailDark;#evernoteEmailPreview .evernoteEmailLong;#evernoteEmailPreview .evernoteEmailShort;#evernoteEmailParticipants;#evernoteEmailLinkBack;#evernoteEmailLinkBackArrow;#evernoteEmailPreview .evernoteEmail;#evernoteEmailPreview .evernoteEmailBody;#evernoteEmailPreview .evernoteEmailAttachments;#evernoteEmailPreview .evernoteEmailAttachments .evernoteEmailSize".split(";"),
d="font-family: Helvetica, Arial, sans-serif !important;{color: #333333 !important; font-weight: bold !important;{font-size: 15px !important;{font-size: 14px !important;{font-size: 12px !important;{float: right !important;{color: #888888 !important;{height: 1px !important;{background-color: #E9E9E9 !important;{background-color: #B3B3B3 !important;{left: -48px !important; position: relative !important; width: -webkit-calc(100% + 96px) !important;{width: 100% !important;{margin: 16px 0 29px 0 !important;{display: block; margin: 22px 0 8px 0 !important; position: relative !important; text-decoration: none !important;{background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAALCAYAAAB24g05AAAAr0lEQVQoU2NkwAKMjY35gcLTzp49G41NHlmMEV2BgYGBNRMT0xJGRkYFoAEY8ujqkRWwGBoa1gI1VwMVMYMUEm2Arq6uEisr62KgrVbINhBlgJGRUQxQ41SgRj5C/sUmzwh0dhzQ2ZPJNgBkKtQLS4EusSDWC8CY+g9SixKIQME6oFgVMYGIzQCw5UAJm////4OiUR5fIOI0AGoIP9CQGefOnYvEFbB4DSAmNmAGAABi7TE0OfL+0wAAAABJRU5ErkJggg==) !important;background-repeat: no-repeat !important; background-size: 16px 11px !important;display: inline-block; height: 11px !important; margin-right: 12px; width: 16px !important;{margin: 24px 0 !important; position: relative !important;{color: #222; font-family: Arial, sans-serif; font-size: 13px; margin-top: 24px !important;{padding: 20px 0 0 40px !important;{margin-left: 10px !important;".split("{"),
f=0;f<b.length;f++)a+=b[f]+"{"+d[f]+"}";b=document.createElement("style");b.innerText=a;document.head||(document.head=document.createElement("head"));document.head.appendChild(b)}function J(a,b){var d={top:Math.min(a.top,b.top),bottom:Math.max(a.bottom,b.bottom),left:Math.min(a.left,b.left),right:Math.max(a.right,b.right)};d.width=d.right-d.left;d.height=d.bottom-d.top;return d}function Q(a){if(0!==a.endOffset||a.endContainer.nodeType!==Node.ELEMENT_NODE)return a=a.getBoundingClientRect(),{top:a.top,
bottom:a.bottom,left:a.left,right:a.right,width:a.width,height:a.height};var b=null;try{b=a.endContainer.getBoundingClientRect()}catch(d){log.warn("Couldn't get a bounding client rect for our end element, maybe it's a text node.")}for(var f=!1,s=[],e=a.getClientRects(),c=0;c<e.length;c++)(b||e[c]?b&&e[c]&&b.top==e[c].top&&b.bottom==e[c].bottom&&b.left==e[c].left&&b.right==e[c].right&&b.width==e[c].width&&b.height==e[c].height:1)&&!f?f=!0:s.push(e[c]);if(0==s.length)return a.getBoundingClientRect();
if(1==s.length)return s[0];a=s[0];for(c=1;c<s.length;c++)a=J(a,s[c]);return a}function K(a,b){var d=b,f=a.getBoundingClientRect(),f={bottom:f.bottom+window.scrollY,height:f.height,left:f.left+window.scrollX,right:f.right+window.scrollX,top:f.top+window.scrollY,width:f.width};if("rtl"==document.dir||0>f.bottom&&0>f.top||0>f.left&&0>f.right)return d;var e=getComputedStyle(a);if("none"==e.display||"hidden"==e.overflowX||"hidden"==e.overflowY)return d;1<f.width*f.height&&(d=J(f,b));if(a.children)for(f=
0;f<a.children.length;f++)d=K(a.children[f],d);return d}function L(){var a;if(void 0!==typeof pageInfo&&!h){a=pageInfo.getSelection();h=[];r=[];for(var b=0;b<a.rangeCount;b++)h.push(a.getRangeAt(b).cloneRange()),r.push([h[b].startOffset,h[b].endOffset]);x=pageInfo.getSelectionFrame()}if(!a){a=window.getSelection();a.removeAllRanges();for(var d=0;d<h.length;d++){var f=document.createRange();if((h[d].startContainer.length||h[d].startContainer.childNodes.length)<r[d][0])for(var e=0,b=0;b<h[d].startContainer.childNodes.length;b++){var c=
h[d].startContainer.childNodes[b],g=0,g=c.getAttribute&&c.getAttribute("clearly_highlight_id")?(c.innerText||c.textContent).length:c.length||c.childNodes.length,e=e+g;if(e>=r[d][0]){f.setStart(c,r[d][0]-(e-g));break}}else f.setStart(h[d].startContainer,r[d][0]);if((h[d].endContainer.length||h[d].endContainer.childNodes.length)<r[d][1])for(b=e=0;b<h[d].endContainer.childNodes.length;b++){if(c=h[d].endContainer.childNodes[b],g=c.getAttribute&&c.getAttribute("clearly_highlight_id")?(c.innerText||c.textContent).length:
c.length||c.childNodes.length,e+=g,e>=r[d][1]){f.setEnd(c,r[d][1]-(e-g));break}}else f.setEnd(h[d].endContainer,r[d][1]);a.addRange(f)}}return a}function M(a){m();g.reset();g.gray(a)}var u=!1,g=new ContentVeil,v=new Veil,R=new GmailClipper,e=null,p=null;SAFARI&&pageInfo.isGmail()&&P();var c=null,A=0,h=null,r=null,x=null,k=function(){var a=document.createElement("div");a.id="evernotePreviewContainer";a.className="evernotePreviewContainer evernotePreviewUrlContainer";return a}(),y,t=function(){var a=
document.createElement("div");a.id="evernoteEmailPreview";return a}();Browser.addMessageHandlers({clearPreview:m,previewArticle:function(a,b,d){u=!0;window.focus();m();c||void 0===typeof pageInfo?c?(D(),1<A&&g.setPageCount(A-1)):log.warn("Couldn't find a 'pageInfo' object."):pageInfo.getDefaultArticle(function(a){c=a;D()},function(a,b,d){A=d;1<d&&g.setPageCount(d-1)})},previewClearly:function(){u=!1;window.focus();m();e?E():O()},previewEmail:function(){m();g.reset();g.gray();t.innerHTML="";var a=
document.createElement("div");a.id="evernoteEmailLoading";t.appendChild(a);t.parentNode||document.documentElement.appendChild(t);var b=document.createElement("div"),d=document.createElement("div");d.className="evernoteEmailHeader evernoteEmailBig";b.appendChild(d);var f=document.createElement("div");f.id="evernoteEmailParticipants";f.className="evernoteEmailHeader evernoteEmailSmall";b.appendChild(f);var e=document.createElement("div");e.className="evernoteEmailDivider evernoteEmailLight evernoteEmailLong";
b.appendChild(e);var c=document.createElement("div");c.id="evernoteEmailSelectAllMessages";c.className="evernoteEmailHeader evernoteEmailMedium evernoteEmailSelectedMessage";var k=document.createElement("div");k.className="evernoteEmailCheckbox";k.addEventListener("click",function(){var a=document.querySelectorAll(".evernoteEmail");if(/evernoteEmailSelectedMessage/.test(this.parentNode.className))for(var b=0;b<a.length;b++)I(a.item(b));else for(b=0;b<a.length;b++)H(a.item(b))});c.appendChild(k);var h=
document.createElement("span");h.innerText=Browser.i18n.getMessage("selectAllMessages");c.appendChild(h);b.appendChild(c);R.getThread(function(c,g){if(c){d.innerText=c.subject;f.innerText=Browser.i18n.getMessage("participants")+": "+Object.keys(c.participants).join(", ");for(var h=0;h<c.messages.length;h++){0!=h&&(e=document.createElement("div"),e.className="evernoteEmailDivider evernoteEmailDark evernoteEmailShort",b.appendChild(e));var m=document.createElement("div");m.className="evernoteEmail evernoteEmailSelectedMessage";
k=document.createElement("div");k.className="evernoteEmailCheckbox";k.addEventListener("click",function(){/evernoteEmailSelectedMessage/.test(this.parentNode.className)?I(this.parentNode):H(this.parentNode)});m.appendChild(k);var n=document.createElement("div"),l=document.createElement("span");l.className="evernoteEmailHeader evernoteEmailMedium";l.innerText=c.messages[h].author.name;n.appendChild(l);l=document.createElement("span");l.className="evernoteEmailDimmed evernoteEmailSmall evernoteEmailRight";
l.innerText=c.messages[h].date;n.appendChild(l);m.appendChild(n);n=document.createElement("div");n.className="evernoteEmailBody";n.innerHTML=c.messages[h].body;m.appendChild(n);if(0<c.messages[h].attachments.length){n=document.createElement("div");n.className="evernoteEmailAttachments";for(l=0;l<c.messages[h].attachments.length;l++){var q=document.createElement("div"),p=document.createElement("span");p.className="evernoteEmailSmall";var r=document.createElement("span");r.className="evernoteEmailDimmed evernoteEmailSmall evernoteEmailSize";
p.textContent=c.messages[h].attachments[l].name;r.textContent="("+c.messages[h].attachments[l].size+")";q.setAttribute("evernote_attachment_url",c.messages[h].attachments[l].url);q.setAttribute("evernote_attachment_name",p.textContent);q.appendChild(p);q.appendChild(r);n.appendChild(q)}m.appendChild(n)}b.appendChild(m)}a.parentNode&&a.parentNode.removeChild(a);t.appendChild(b)}else alert(g)})},previewFullPage:function(){u=!1;var a=document.body.scrollWidth,b=document.body.scrollHeight,a={bottom:b-
4,top:4,left:4,right:a-4,width:a-8,height:b-8};m();g.revealStaticRect(a,document.body);g.show();z()},previewPdf:function(){u=!1;m()},previewSelection:function(){u=!1;var a=L();g.reset();var b=null;x&&(b=x.getBoundingClientRect());var d,c;if(a)for(m(),g.reset(),c=0;c<a.rangeCount;c++)d=a.getRangeAt(c),d=Q(d),d.top+=document.body.scrollTop,d.bottom+=document.body.scrollTop,d.left+=document.body.scrollLeft,d.right+=document.body.scrollLeft,b&&(d.left+=b.left,d.right+=b.left,d.top+=b.top,d.bottom+=b.top),
g.revealStaticRect(d,x,!1),g.show();g.show()},previewSkitch:function(){M("transparent");v.reset();v.showVeil();v.setColor("rgba(0, 0, 0, 0.27)");v.enableCrosshair()},previewUrl:function(a,b,d){function c(a){k.innerHTML="";k.appendChild(a);B()}u=!1;var e=document.title,h=document.location.href,p=pageInfo.favIconUrl;m();g.gray();pageInfo.getRecommendationText(!0,function(a){if(a=C(e,h,p,a,c))k.innerHTML="",k.appendChild(a),B()})},receiveCroppedImage:function(a,b,d){y&&(y.src=a.datauri,y.removeAttribute("thumbnail"))},
receiveScreenshot:function(){document.body.style.overflowY="";document.body.style.overflowX="";m()}});this.clear=m;this.clearHighlights=function(){p&&p.highlight__deleteAllHighlights()};this.getArticleElement=function(){return c};this.getUrlElement=function(a){function b(){var a=k.querySelector("[thumbnail]");a&&a.parentNode.parentNode.removeChild(a.parentNode);for(var a="",b=k.innerHTML.split(/(?=<img.[^>]+>)/),c=0;c<b.length;c++)a=/^<img/.test(b[c])?a+b[c].replace(/>/,"></img>"):a+b[c];return a}
if(k.innerHTML)return b();pageInfo.getRecommendationText(!0,function(d){if(d=C(document.title,document.location.href,pageInfo.favIconUrl,d,function(d){d&&(k.innerHTML="",k.appendChild(d),a(b()))}))k.innerHTML="",k.appendChild(d),a(b())})};this.getClearlyReformat=function(){return e};this.looksInteresting=w;this.computeDescendantBoundingBox=function(a){if(!a)return{top:0,bottom:0,left:0,right:0,width:0,height:0};var b=a.getBoundingClientRect();return K(a,{bottom:b.bottom+window.scrollY,height:b.height,
left:b.left+window.scrollX,right:b.right+window.scrollX,top:b.top+window.scrollY,width:b.width})};this.getEmailElement=function(){if(t){for(var a=t.firstElementChild,b=a.querySelectorAll(".evernoteEmailCheckbox, #evernoteEmailSelectAllMessages, .evernoteEmail:not(.evernoteEmailSelectedMessage)"),d=0;d<b.length;d++)if(b.item(d).parentNode){if(b.item(d).webkitMatchesSelector(".evernoteEmail")){var c=b.item(d).previousElementSibling;c&&/evernoteEmailDivider/.test(c.className)&&/evernoteEmailShort/.test(c.className)||
(c=b.item(d).nextElementSibling);c&&c.parentNode&&/evernoteEmailDivider/.test(c.className)&&/evernoteEmailShort/.test(c.className)&&c.parentNode.removeChild(c)}if("evernoteEmailSelectAllMessages"==b.item(d).id){c=document.createElement("a");c.id="evernoteEmailLinkBack";c.className="evernoteEmailHeader evernoteEmailMedium";c.target="_blank";c.href=document.location.href;var e=document.createElement("div");e.id="evernoteEmailLinkBackArrow";c.appendChild(e);e=document.createElement("span");e.innerText=
Browser.i18n.getMessage("openConvoInGmail");c.appendChild(e);b.item(d).parentNode.insertBefore(c,b.item(d))}b.item(d).parentNode.removeChild(b.item(d))}if(b=a.querySelector(".evernoteEmailDivider.evernoteEmailLong"))b.className=b.className.replace(/\s*evernoteEmailLong/g," evernoteEmailShort");return a}return null};this.ensureSelectionIsShown=L;this.expandPreview=function(){if(u){for(var a=c,b=c.parentNode;b;){if(w(b,c)){b.enNudgeDescendToNode=c;c=b;break}b=b.parentNode}a!==c&&g.outlineElement(c,
!1,!0,!0)}};this.contractPreview=function(){if(u){var a=c;if(c.enNudgeDescendToNode){var b=c.enNudgeDescendToNode;delete c.enNudgeDescendToNode;c=b}else c=G(c);a!==c&&g.outlineElement(c,!1,!0,!0)}};this.moveToElementAbove=function(){if(u)for(var a=c.previousElementSibling;a;){if(w(a,c)){c=a;g.outlineElement(c,!1,!0,!0);break}a=a.previousElementSibling}};this.moveToElementBelow=function(){if(u)for(var a=c.nextElementSibling;a;){if(w(a,c)){c=a;g.outlineElement(c,!1,!0,!0);break}a=a.nextElementSibling}};
this.isPointOnVeil=function(a,b){var c=parseFloat(g.getElement().style.borderTopWidth),e=parseFloat(g.getElement().style.borderRightWidth),h=parseFloat(g.getElement().style.borderBottomWidth),k=parseFloat(g.getElement().style.borderLeftWidth),m=parseFloat(g.getElement().style.width),p=parseFloat(g.getElement().style.height);return a<m-e&&a>k&&b>c&&b<p-h?!1:!0};this.reset=function(){x=r=h=null};this.gray=M;Object.preventExtensions(this)};
